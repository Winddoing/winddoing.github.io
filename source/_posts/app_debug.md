---
title: Linux应用调试方法---Debug
date: 2017-12-20 23:07:24
categories: Linux内核
tags: [kernel, Debug]
---

常用的Linux应用调试方法：`GDB`

<!--more-->
## strace

### 用法：

``` shell
strace ./a.out
```

## gdb

core dump
### 查看core设置

``` shell
ulimit -a
```

```
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 30956
max locked memory       (kbytes, -l) 16384
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 30956
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

### 开启core file

``` shell
ulimit -c unlimited
```

### 示例

> ubuntu18.04 64bit

* 异常程序(段错误)

``` C
#include <stdio.h>
#include <stdlib.h>

int main(int argc, char *argv[])
{
    int *a;

    *a = 1;

    while(1)
    {

    }
    return EXIT_SUCCESS;
}
```
- 编译*
```
gcc -g test.c
```

* 运行异常程序后,生成core文件

* 使用gdb查看异常位置

``` shell
gdb ./a.out core
```
```
GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./a.out...done.

warning: exec file is newer than core file.
[New LWP 20661]
Core was generated by `./a.out'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000563a00047609 in main (argc=1, argv=0x7ffe99b73178) at tst.c:8
8	    *a = 1;
```

### ARM平台

> 本地编译支持arm平台的gdb

``` shell
#!/bin/bash
PWD=`pwd`

mkdir tmp
cd tmp

if [ ! -f gdb-8.2.tar.gz ]; then
    wget http://101.110.118.57/ftp.gnu.org/gnu/gdb/gdb-8.2.tar.gz
fi

rm gdb-8.2 -rf
tar zxvf gdb-8.2.tar.gz

cd gdb-8.2

./configure --target=arm-linux --prefix=$PWD/_install  --enable-static
make -j2
make install

cd .. #gdb-8.2
cd .. #tmp
```

### 交叉编译

目标平台直接使用gdb调试

## gdb调试

```
gdb ./a,out
```

* 动态的改变你程序的执行环境

### 启动调试

| 启动方式  | 说明  |
|:--------:|:------|
| `$gdb`  | 直接进去交互模式  |
| `$gdb -tui`   | 启动可以直接将屏幕分成两个部分，上面显示源代码,上下方向键可以查看源代码,想要命令行使用上下键就用`Ctrl+n`和`Ctrl+p`  |
| `$gdb app`   | 启动gdb调试指定程序app  |
| `$gdb <program> <PID>`  | <program>是程序的可执行文件名，<PID>是要调试程序的PID |
| `$gdb <PID>`  | <PID>是要调试程序的PID, 此时无法查看源码，使用`file`命令指明可执行文件就可以显示源代码  |

### 调试交互

>以下所有命令可以在调试时，使用`Tab`进行补全

| 命令  | 别名 |说明  |
|:-----:|:---:|:-----|
| `help` | | 显示帮助信息  |
| `file app` | | 载入指定的程序,编译app的时候要加入`-g`调试选项  |
| `list n1 n2`  | `l`  | 列出指定区域(n1到n2之间)的代码[详见list](#list)  |
| `start`  |   | 开始执行程序,在main函数的第一条语句前面停下来  |
| `run`  | `r` | 重新运行调试的程序, 它后面可以跟随发给该程序的任何参数，包括标准输入和标准输出说明符(<和> )和shell通配符（*、？、[、]）在内|
| `continue`  |   | 继续运行程序直接运行到下一个断点  |
| `next`  | `n`  | 执行下一步(执行一行代码，如果是函数也会跳过函数)  |
| `next N `  | `n N`  | 执行N次下一步  |
| `step`  |   | 单步进入(执行一行代码，如果遇到函数进入函数的内部，再一行一行的执行)  |
| `finish`  |   | 执行完当前函数返回到调用它的函数  |
| `until`  | `u`  | 指定程序直到退出当前循环体  |
| `jump 5` | `j 5`  | 跳转执行程序到第5行  |
| `return`  |   | 强制返回当前函数  |
| `call <expr>`  |   | 强制调用函数, 如果函数的返回类型是void那么就不会打印函数的返回值  |
| `print <expr>`  |   | 强制调用函数, 如果函数的返回值是void那么call不会打印返回值  |
| `break 6`  | `b 6`  | 在当前的文件中某一行（假设为6）设定断点  |
| `break 46 if testsize==100`  |   | 设置条件断点(如果testsize==100就在46行处断点)  |
| `watch <expr>`  |   | <expr> 为表达式（变量）expr设置一个观察点。一量表达式值有变化时，马上停住程序(也是一种断点)  |
| `watch i != 10`  |   | 检测表达式变化则停住,i != 10这个表达式一旦变化，则停住 |
| `break func`  | `b func`  | 在当前的文件中为某一函数(假设为func)处设定断点  |
| `break fileName:N`  | `b fileName:N`  | 给指定文件（fileName）的某个行（N）处设置断点  |
| `info breakpoints`  | `info break`  | 显示当前gdb断点信息  |
| `print var`  |   | print显示变量(var)值[详见print](#print)  |
| `set var name=v`  |   | 设置变量的值  |
| `delete N`  |   | 删除N号断点  |
| `delete`  |   | 删除所有断点  |
| `clear N`  |   | 清除行N上面的所有断点  |
| `clear`  |   | 清除所有断点  |
| `backtrace`  | `bt`  | 显示当前调用函数堆栈中的函数  |
| `frame`  | `f`  | 查看栈帧  |
| `set args no`  |   | 修改发送给程序的参数  |
| `show args`  |   | 显示缺省的参数列表  |
| `show language`  |   | 查看当前调试程序的语言环境,默认是c语言  |
| `info function`  |   | 查看当前函数的程序语言  |
| `set language c++`  |   | 手动设置当前的程序语言为c++  |
| `set language`  |   | 查看可以设置的程序语言  |
| `kill`  |   | 终止一个正在调试的程序  |
| `whatis var`  |   | 显示一个变量var的类型  |
| `ptype var`  |   | 以更详细的方式显示变量var的类型, 会打印出var的结构定义 |
| `info source`  |   |  显示当前的调试源文件 |
| `info locals`  | `i locals`  | 查看当前程序栈的局部变量  |
| `info registers`  |   | 查看当前寄存器的值(不包括浮点寄存器)   |
| `info all-registers`  |   | 查看当前寄存器的值,包括浮点寄存器  |
| `info frame`  |   | 查看当前程序栈的信息  |
| `x/10x $sp`  |   | 查看当前程序栈的内容  |
| `display`  |   | 跟踪查看某个变量,每次停下来都显示它的值  |
| `[Enter]`  |   | 直接回车，执行上一步命令  |
| `quit`  | `q`  | 退出gdb环境  |


#### list

`list`默认显示当前行和之后的10行，再执行又下滚10行

list后可以使用不同参数：
- `<linenum>` : 行号
- `<+offset>` : 当前行号的正偏移量
- `<-offset>` : 当前行号的负偏移量
- `<filename:linenum>` : 哪个文件的哪一行
- `<function>` : 函数名
- `<filename:function>` : 哪个文件中的哪个函数
- `<*address>` : 程序运行时的语句在内存中的地址

#### print

`print`有打印显示变量（数组、结构体）与修改运行时变量的功能

- `print /x var`: 用16进制显示(var)值
> print可以指定显示的格式，这里用'/x'表示16进制的格式
> - `x`: 按十六进制格式显示变量。
> - `d`: 按十进制格式显示变量。
> - `u`: 按十六进制格式显示无符号整型。
> - `o`: 按八进制格式显示变量。
> - `t`: 按二进制格式显示变量。
> - `a`: 按十六进制格式显示变量。
> - `c`: 按字符格式显示变量。
> - `f`: 按浮点数格式显示变量。

**使用打印功能时：`var`可以是变量、数组、结构体**

``` C
(gdb) print aa //数组
$1 = {1, 3, 5, 6, 12, 33, 66, 12, 67}
(gdb) print tst //结构体
$2 = {a = 11, b = 88, c = 44}
(gdb) print i //变量
$3 = 9
(gdb) print /x i
$4 = 0x9
(gdb) print /x tst
$5 = {a = 0xb, b = 0x58, c = 0x2c}
(gdb) print /x aa
$6 = {0x1, 0x3, 0x5, 0x6, 0xc, 0x21, 0x42, 0xc, 0x43}
```

#### 打印内存地址

`x[/n] <address>`打印内存地址的值,n表示后面连续n个地址的值

```
(gdb) x/10 0x7ffffffee3c8
0x7ffffffee3c8: 0xfffee5f7      0x00007fff      0x00000000      0x00000000
0x7ffffffee3d8: 0xfffee60f      0x00007fff      0xfffeec01      0x00007fff
0x7ffffffee3e8: 0xfffeec11      0x00007fff
(gdb) x 0x7ffffffee3c8
0x7ffffffee3c8: 0xfffee5f7
```

## 图形化gdb调试

### cgdb

cgdb是GNU调试器（GDB）的轻量级curses（基于终端）接口。 除了标准的gdb控制台之外，cgdb还提供了一个分屏视图，可以在执行时显示源代码。

>官网： [http://cgdb.github.io](http://cgdb.github.io)

![cgdb](/images/2019/04/cgdb.png)

cgdb分为上下两栏，上面类似于vi窗口显示对应的代码，下面gdb窗口进行命令调试操作

#### 操作

| 命令  |         说明          |
|:-----:|:---------------------:|
| `ESC` |  输入焦点进入VI窗口   |
|  `i`  | 输入焦点进入gdb控制台 |


#### VI窗口

调试快捷键

| 功能键 | 作用                             |
|:------:|:---------------------------------|
|  `F5`  | Send a `run` command to GDB      |
|  `F6`  | Send a `continue` command to GDB |
|  `F7`  | Send a `finish` command to GDB   |
|  `F8`  | Send a `next` command to GDB     |
| `F10`  | Send a `step` command to GDB     |


#### 控制台

进入控制台使用方法与gdb一样


## VScode

gdb的图形化调试，方便

![vscode_debug](/images/2019/06/vscode_debug.png)

### 常用插件

| 插件  | 作用  |
|:-:|:-:|
| c-cpp-project-generator  | 直接生成项目文件  |
| Chinese (Simplified)  | 汉化  |
| CMake Tools  | cmake  |
| Code Runner  | 结合WSL编译调试  |

### 编译

> 配置文件：task.json

```
{
    // See https://go.microsoft.com/fwlink/?LinkId=733558
    // for the documentation about the tasks.json format
    "version": "2.0.0",
    "tasks": [
        {
            "label": "build",
            "type": "shell",
            "command": "bash && make"
        }
    ]
}
```

### 调试

> 配置文件：lanuch.json

```
{
    // 使用 IntelliSense 了解相关属性。
    // 悬停以查看现有属性的描述。
    // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) Launch",
            "type": "cppdbg",
            "request": "launch",
            "program": "/home/wqshao/work/jpeg/jpeg_vgtp_tuning/build/bin/tunning_vgtp_codec",
            "args": [
                "-a", "-f", "/home/wqshao/Pictures/test_yuv/app_JDshopping_1080p_30fps_444_295.yuv",
                "-r", "1920x1080", "-c", "20", "-s", "0", "-m", "0"
            ],
            "stopAtEntry": true,
            "cwd": "${workspaceFolder}",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```
- `program`: 需要调试的程序（必须为完整程序路径，可以使用VSCode的环境变量）
- `args`: 启动时传递给程序的命令行参数的JSON数据。例如： ["arg1", "arg2].
- `stopAtEntry`: 是否停在程序入口点（停在main函数开始）
- `cwd`: 设置调试器启动的应用程序的工作目录。
- `environment`: 针对调试的程序，要添加到环境中的环境变量. 例如: [ { "name": "squid", "value": "clam" } ]。


### 问题

#### 设置断点失效

> 检查编译时，是否添加`-g`选项

#### Win10使用WSL

安装插件`Code Runner`

> launch.json
```
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) Bash on Windows Launch",
            "type": "cppdbg",
            "request": "launch",
            "program": "/mnt/c/Users/Administrator/Desktop/test/bin/main",
            "args": [],
            "stopAtEntry": true,
            "cwd": "/mnt/c/Users/Administrator/Desktop/test",
            "environment": [],
            "externalConsole": true,
            "pipeTransport": {
                "debuggerPath": "/usr/bin/gdb",
                "pipeProgram": "${env:windir}\\system32\\bash.exe",
                "pipeArgs": ["-c"],
                "pipeCwd": ""
            },
             "sourceFileMap": {
                "/mnt/c": "c:\\"
            },
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```

## 参考

* [Visual Studio Code （VSCode） 之 C/C++ 调试配置详解](https://blog.csdn.net/zcshoucsdn/article/details/60466707)
