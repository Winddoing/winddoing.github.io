<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=#222 media="(prefers-color-scheme: light)"><meta name=theme-color content=#222 media="(prefers-color-scheme: dark)"><meta name=generator content="Hexo 6.2.0"><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preconnect href=https://cdnjs.cloudflare.com crossorigin><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon.ico><link rel=mask-icon href=/images/logo.svg color=#222><meta name=baidu-site-verification content=WIIeufYjj6><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Microsoft+YaHei:300,300italic,400,400italic,700,700italic%7Ccmmi10:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><script class=next-config data-name=main type=application/json>{"hostname":"winddoing.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.12.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content="RDMA(Remote Direct Memory Access)全称远程直接数据存取，就是为了解决网络传输中服务器端数据处理的延迟而产生的。RDMA通过网络把资料直接传入计算机的存储区，将数据从一个系统快速移动到远程系统存储器中，而不对操作系统造成任何影响，这样就不需要用到多少计算机的处理功能。它消除了外部存储器复制和上下文切换的开销，因而能解放内存带宽和CPU周期用于改进应用系统性能。"><meta property=og:type content=article><meta property=og:title content=RDMA网络简介><meta property=og:url content=https://winddoing.github.io/post/f4fa9e36.html><meta property=og:site_name content="Winddoing&#39;s Notes"><meta property=og:description content="RDMA(Remote Direct Memory Access)全称远程直接数据存取，就是为了解决网络传输中服务器端数据处理的延迟而产生的。RDMA通过网络把资料直接传入计算机的存储区，将数据从一个系统快速移动到远程系统存储器中，而不对操作系统造成任何影响，这样就不需要用到多少计算机的处理功能。它消除了外部存储器复制和上下文切换的开销，因而能解放内存带宽和CPU周期用于改进应用系统性能。"><meta property=og:locale content=zh_CN><meta property=og:image content=https://winddoing.github.io/images/2021/05/netdata_rdma_ib.png><meta property=article:published_time content=2021-05-28T06:27:00.000Z><meta property=article:modified_time content=2023-12-16T04:58:17.933Z><meta property=article:author content=winddoing><meta property=article:tag content=网络><meta property=article:tag content=rdma><meta name=twitter:card content=summary><meta name=twitter:image content=https://winddoing.github.io/images/2021/05/netdata_rdma_ib.png><link rel=canonical href=https://winddoing.github.io/post/f4fa9e36.html><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://winddoing.github.io/post/f4fa9e36.html","path":"post/f4fa9e36.html","title":"RDMA网络简介"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>RDMA网络简介 | Winddoing's Notes</title><script src=/js/third-party/analytics/baidu-analytics.js></script><script async src=https://hm.baidu.com/hm.js?b96a560ce0a6bfbeaaddc59dc5888b75></script><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href="/" class=brand rel=start><i class=logo-line></i><p class=site-title>Winddoing's Notes</p><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Follow Excellent, Success will Chase you</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#%E9%A9%B1%E5%8A%A8%E4%B8%8B%E8%BD%BD><span class=nav-number>1.</span> <span class=nav-text>驱动下载</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#CentOS7%E5%BC%80%E6%BA%90%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD><span class=nav-number>1.1.</span> <span class=nav-text>CentOS7开源驱动安装与卸载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%90%9E%E5%90%90%E9%87%8F%E6%B5%8B%E8%AF%95><span class=nav-number>2.</span> <span class=nav-text>吞吐量测试</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%86%99%E5%90%9E%E5%90%90%E9%87%8F><span class=nav-number>2.1.</span> <span class=nav-text>写吞吐量</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#%E8%AF%BB%E5%90%9E%E5%90%90%E9%87%8F><span class=nav-number>2.2.</span> <span class=nav-text>读吞吐量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%BB%B6%E6%97%B6%E6%B5%8B%E8%AF%95><span class=nav-number>3.</span> <span class=nav-text>延时测试</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%B8%A6%E5%AE%BD%E7%BB%9F%E8%AE%A1><span class=nav-number>4.</span> <span class=nav-text>带宽统计</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BD%91%E7%BB%9C%E8%81%94%E9%80%9A%E6%80%A7%E6%B5%8B%E8%AF%95><span class=nav-number>5.</span> <span class=nav-text>网络联通性测试</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Server><span class=nav-number>5.1.</span> <span class=nav-text>Server</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#Client><span class=nav-number>5.2.</span> <span class=nav-text>Client</span></a></li></ol></li><li class="nav-item nav-level-2"><a class=nav-link href=#ibping><span class=nav-number>6.</span> <span class=nav-text>ibping</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#mlx5%E8%AE%A1%E6%95%B0%E5%99%A8%E5%92%8C%E7%8A%B6%E6%80%81%E5%8F%82%E6%95%B0><span class=nav-number>7.</span> <span class=nav-text>mlx5计数器和状态参数</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#counters><span class=nav-number>7.1.</span> <span class=nav-text>counters</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#hw-counters><span class=nav-number>7.2.</span> <span class=nav-text>hw_counters</span></a></li></ol></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%B8%A6%E5%AE%BD%E7%9B%91%E6%B5%8B%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94netdata><span class=nav-number>8.</span> <span class=nav-text>带宽监测工具——netdata</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%BD%91%E5%8D%A1%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F><span class=nav-number>9.</span> <span class=nav-text>网卡工作模式</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4><span class=nav-number>10.</span> <span class=nav-text>常用命令</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%8F%8C%E7%BD%91%E5%8F%A3%E4%BD%9C%E7%94%A8><span class=nav-number>11.</span> <span class=nav-text>双网口作用</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%8F%82%E8%80%83><span class=nav-number>12.</span> <span class=nav-text>参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=winddoing src=/images/Winddoing.jpg><p class=site-author-name itemprop=name>winddoing</p><div class=site-description itemprop=description>失败缘于忽视细处，成功始于重视小事</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>358</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>112</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>284</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9naXRodWIuY29tL1dpbmRkb2luZw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Winddoing"><i class="fab fa-github fa-fw"></i>GitHub</span></span> <span class=links-of-author-item><span class=exturl data-url=aHR0cHM6Ly9naXRlZS5jb20vd2luZGRvaW5n title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;winddoing"><i class="fab fa-codiepie fa-fw"></i>Gitee</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy85NTY3MzYxL3dpbmRkb2luZw==" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;9567361&#x2F;winddoing"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9hcHAudHJhdmlzLWNpLmNvbS9naXRodWIvV2luZGRvaW5nL3dpbmRkb2luZy5naXRodWIuaW8=" title="Travis CI → https:&#x2F;&#x2F;app.travis-ci.com&#x2F;github&#x2F;Winddoing&#x2F;winddoing.github.io"><i class="fas fa-terminal fa-fw"></i>Travis CI</span></span></div><div class="cc-license site-overview-item animated" itemprop=license><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg alt="Creative Commons"></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="link fa-fw"></i> Links</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cHM6Ly93aW5kZG9pbmcuZ2l0Ym9vay5pby9lbWJlZGRlZF9saW51eF9ub3Rlcy8=" title=https:&#x2F;&#x2F;winddoing.gitbook.io&#x2F;embedded_linux_notes&#x2F;>嵌入式相关</span></li><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2RyZWFtcQ==" title=http:&#x2F;&#x2F;blog.csdn.net&#x2F;sdreamq>CSDN</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cDovL3d3dy53b3dvdGVjaC5uZXQv title=http:&#x2F;&#x2F;www.wowotech.net&#x2F;>蜗窝科技</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpb25neGlhbnpl title=https:&#x2F;&#x2F;blog.csdn.net&#x2F;xiongxianze>xiongxianze</span></li></ul></div><div id=days></div><script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("02/26/2014 15:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=https://winddoing.github.io/post/f4fa9e36.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/Winddoing.jpg><meta itemprop=name content=winddoing></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Winddoing's Notes"><meta itemprop=description content=失败缘于忽视细处，成功始于重视小事></span> <span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="RDMA网络简介 | Winddoing's Notes"><meta itemprop=description></span><header class=post-header><h1 class=post-title itemprop="name headline">RDMA网络简介</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2021-05-28 14:27:00" itemprop="dateCreated datePublished" datetime=2021-05-28T14:27:00+08:00>2021-05-28</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop=url rel=index><span itemprop=name>网络</span></a></span> ， <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C/" itemprop=url rel=index><span itemprop=name>网络</span></a></span></span> <span id=/post/f4fa9e36.html class="post-meta-item leancloud_visitors" data-flag-title=RDMA网络简介 title=阅读次数><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span class=leancloud-visitors-count></span></span> <span class=post-meta-item title=阅读次数 id=busuanzi_container_page_pv><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span></span> <span class=post-meta-break></span> <span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>14k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>13 分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><p><code>RDMA</code>(Remote Direct Memory Access)全称<code>远程直接数据存取</code>，就是为了解决网络传输中服务器端数据处理的延迟而产生的。RDMA通过网络把资料直接传入计算机的存储区，将数据从一个系统快速移动到远程系统存储器中，而不对操作系统造成任何影响，这样就不需要用到多少计算机的处理功能。它消除了外部存储器复制和上下文切换的开销，因而能解放内存带宽和CPU周期用于改进应用系统性能。</p><span id=more></span><h2 id=驱动下载><a href=#驱动下载 class=headerlink title=驱动下载></a>驱动下载</h2><blockquote><p><span class=exturl data-url="aHR0cHM6Ly93d3cubWVsbGFub3guY29tL3Byb2R1Y3RzL2luZmluaWJhbmQtZHJpdmVycy9saW51eC9tbG54X29mZWQ=">https://www.mellanox.com/products/infiniband-drivers/linux/mlnx_ofed<i class="fa fa-external-link-alt"></i></span></p></blockquote><p>判断驱动是否安装成功：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>ibdev2netdev</span></span><br><span class=line>mlx5_0 port 1 ==&gt; ens2f0 (Up)   #表示该网口插了网线</span><br><span class=line>mlx5_1 port 1 ==&gt; ens2f1 (Down) #表示该网口没有插网线</span><br></pre></td></tr></table></figure><blockquote><p><code>ibdev2netdev</code>命令输出以上类似信息表明网卡驱动安装成功</p></blockquote><h3 id=CentOS7开源驱动安装与卸载><a href=#CentOS7开源驱动安装与卸载 class=headerlink title=CentOS7开源驱动安装与卸载></a>CentOS7开源驱动安装与卸载</h3><blockquote><p><span class=exturl data-url="aHR0cHM6Ly93d3cucmRtYW1vam8uY29tLzIwMTQvMTAvMTEvd29ya2luZy1yZG1hLXJlZGhhdGNlbnRvcy03LyM6fjp0ZXh0PXl1bSUyMGFsbG93cyUyMGluc3RhbGxhdGlvbiUyMG9mJTIwbXVsdGlwbGUlMjBwYWNrYWdlcyUyMGFjY29yZGluZyUyMHRvLHBhY2thZ2VzJTIwYXJlJTIwcGFydCUyMG9mJTIwdGhlJTIwZ3JvdXAlMjAlMjJJbmZpbmliYW5kJTIwU3VwcG9ydCUyMiUzQQ==">Working with RDMA in RedHat&#x2F;CentOS 7.*<i class="fa fa-external-link-alt"></i></span></p></blockquote><ul><li>安装：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>yum groupinfo &quot;Infiniband Support&quot;</span><br><span class=line>yum groupinstall &quot;Infiniband Support&quot;</span><br><span class=line>yum --setopt=group_package_types=optional groupinstall &quot;Infiniband Support&quot;</span><br></pre></td></tr></table></figure></li><li>卸载：<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum -y groupremove &quot;Infiniband Support&quot;</span><br></pre></td></tr></table></figure></li><li>开启RDMA服务<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>systemctl start rdma</span><br><span class=line>systemctl enable rdma</span><br></pre></td></tr></table></figure></li></ul><h2 id=吞吐量测试><a href=#吞吐量测试 class=headerlink title=吞吐量测试></a>吞吐量测试</h2><h3 id=写吞吐量><a href=#写吞吐量 class=headerlink title=写吞吐量></a>写吞吐量</h3><p>在RDMA驱动安装时会安装一些RDMA工具，可以使用<code>ib_send_bw</code>测试写吞吐量</p><p>服务器A（server）：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>ib_write_bw -a -d mlx5_0</span><br></pre></td></tr></table></figure><p>服务器B（client）：</p><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>ib_write_bw -a -d mlx5_0 192.168.2.1(server端ip)</span><br></pre></td></tr></table></figure><h3 id=读吞吐量><a href=#读吞吐量 class=headerlink title=读吞吐量></a>读吞吐量</h3><p>读吞吐量的测试与写吞吐量测试相同，只是使用命令换为<code>ib_read_bw</code></p><h2 id=延时测试><a href=#延时测试 class=headerlink title=延时测试></a>延时测试</h2><p>测试同样分为读写，测试工具为<code>ib_read_lat</code>、<code>ib_write_lat</code></p><ul><li><span class=exturl data-url=aHR0cHM6Ly9jb21tdW5pdHkubWVsbGFub3guY29tL3MvYXJ0aWNsZS9wZXJmb3JtYW5jZS10dW5pbmctZm9yLW1lbGxhbm94LWFkYXB0ZXJz>Performance Tuning for Mellanox Adapters<i class="fa fa-external-link-alt"></i></span></li></ul><h2 id=带宽统计><a href=#带宽统计 class=headerlink title=带宽统计></a>带宽统计</h2><p>在使用RDMA时，发送和接收的数据带宽可以在app中自己进行收集，这样我们的程序发送和接收的数据量会很清楚。<br>如果想知道当前RDMA网卡所发送和接收的带宽可以通过sysfs下的相关节点获取。</p><ul><li>发送数据量（byte）：<code>/sys/class/infiniband/mlx5_0/ports/1/counters/port_xmit_data</code></li><li>接收数据量（byte）：<code>/sys/class/infiniband/mlx5_0/ports/1/counters/port_rcv_data</code></li></ul><p><strong>注</strong>：<code>port_xmit_data</code>和<code>port_rcv_data</code>的数值是实际的1&#x2F;4,因此实际的带宽是在其基础之上乘以<code>4</code>，应该是为了防止数据溢出</p><blockquote><p>port_xmit_data: (RO) Total number of data octets, divided by 4 (lanes), transmitted on all VLs. This is 64 bit counter<br>port_rcv_data: (RO) Total number of data octets, divided by 4 (lanes), received on all VLs. This is 64 bit counter.</p><blockquote><p>来自： <code>Documentation/ABI/stable/sysfs-class-infiniband</code></p></blockquote></blockquote><figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>pma_cnt_ext-&gt;port_xmit_data =</span><br><span class=line>    cpu_to_be64(MLX5_SUM_CNT(out, transmitted_ib_unicast.octets,</span><br><span class=line>                 transmitted_ib_multicast.octets) &gt;&gt; <span class=number>2</span>);</span><br><span class=line>pma_cnt_ext-&gt;port_rcv_data =</span><br><span class=line>    cpu_to_be64(MLX5_SUM_CNT(out, received_ib_unicast.octets,</span><br><span class=line>                 received_ib_multicast.octets) &gt;&gt; <span class=number>2</span>);</span><br></pre></td></tr></table></figure><blockquote><p>file: drivers&#x2F;infiniband&#x2F;hw&#x2F;mlx5&#x2F;mad.c</p></blockquote><h2 id=网络联通性测试><a href=#网络联通性测试 class=headerlink title=网络联通性测试></a>网络联通性测试</h2><p>由于当前网卡只支持<code>Ethernet</code>模式，因此只能使用<code>ibv_rc_pingpong</code>进行ping测试。</p><ul><li><span class=exturl data-url=aHR0cHM6Ly9jb21tdW5pdHkubWVsbGFub3guY29tL3MvYXJ0aWNsZS9Sb0NFLURlYnVnLUZsb3ctZm9yLUxpbnV4>https://community.mellanox.com/s/article/RoCE-Debug-Flow-for-Linux<i class="fa fa-external-link-alt"></i></span></li></ul><h3 id=Server><a href=#Server class=headerlink title=Server></a>Server</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>ibdev2netdev</span></span><br><span class=line>mlx4_0 port 1 ==&gt; enp1s0 (Down)</span><br><span class=line>mlx5_0 port 1 ==&gt; ens2f0 (Up)</span><br><span class=line>mlx5_1 port 1 ==&gt; ens2f1 (Up)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>ibv_rc_pingpong -d mlx5_0 -g 0</span></span><br><span class=line>  local address:  LID 0x0000, QPN 0x00011a, PSN 0xd775ee, GID fe80::e42:a1ff:fe41:2d36</span><br><span class=line>  remote address: LID 0x0000, QPN 0x0009df, PSN 0xa7f02f, GID fe80::1e34:daff:fe79:c0d</span><br><span class=line>8192000 bytes in 0.01 seconds = 5126.01 Mbit/sec</span><br><span class=line>1000 iters in 0.01 seconds = 12.78 usec/iter</span><br></pre></td></tr></table></figure><h3 id=Client><a href=#Client class=headerlink title=Client></a>Client</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>ibdev2netdev</span></span><br><span class=line>mlx5_0 port 1 ==&gt; p5p1 (Down)</span><br><span class=line>mlx5_1 port 1 ==&gt; p5p2 (Up)</span><br><span class=line>mlx5_2 port 1 ==&gt; p4p1 (Down)</span><br><span class=line>mlx5_3 port 1 ==&gt; p4p2 (Down)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>ibv_rc_pingpong -d mlx5_1 -g 0 192.168.2.4</span></span><br><span class=line>  local address:  LID 0x0000, QPN 0x0009df, PSN 0xa7f02f, GID fe80::1e34:daff:fe79:c0d</span><br><span class=line>  remote address: LID 0x0000, QPN 0x00011a, PSN 0xd775ee, GID fe80::e42:a1ff:fe41:2d36</span><br><span class=line>8192000 bytes in 0.01 seconds = 5376.21 Mbit/sec</span><br><span class=line>1000 iters in 0.01 seconds = 12.19 usec/iter</span><br></pre></td></tr></table></figure><h2 id=ibping><a href=#ibping class=headerlink title=ibping></a>ibping</h2><p>测试ib模式下网络的连通性。</p><h2 id=mlx5计数器和状态参数><a href=#mlx5计数器和状态参数 class=headerlink title=mlx5计数器和状态参数></a>mlx5计数器和状态参数</h2><p>在sysfs文件系统可以查看<code>/sys/class/infiniband/</code></p><blockquote><ul><li><span class=exturl data-url=aHR0cHM6Ly9jb21tdW5pdHkubWVsbGFub3guY29tL3MvYXJ0aWNsZS91bmRlcnN0YW5kaW5nLW1seDUtbGludXgtY291bnRlcnMtYW5kLXN0YXR1cy1wYXJhbWV0ZXJz>Understanding mlx5 Linux Counters and Status Parameters<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url=aHR0cHM6Ly9teW1lbGxhbm94LmZvcmNlLmNvbS9tZWxsYW5veGNvbW11bml0eS9zL2FydGljbGUvaW5maW5pYmFuZC1wb3J0LWNvdW50ZXJz>InfiniBand Port Counters<i class="fa fa-external-link-alt"></i></span></li></ul></blockquote><p>Linux内核说明文档：<span class=exturl data-url=aHR0cHM6Ly93d3cua2VybmVsLm9yZy9kb2MvaHRtbC9sYXRlc3QvYWRtaW4tZ3VpZGUvYWJpLXN0YWJsZS5odG1sI2FiaS1maWxlLXN0YWJsZS1zeXNmcy1jbGFzcy1pbmZpbmliYW5k>https://www.kernel.org/doc/html/latest/admin-guide/abi-stable.html#abi-file-stable-sysfs-class-infiniband<i class="fa fa-external-link-alt"></i></span></p><h3 id=counters><a href=#counters class=headerlink title=counters></a>counters</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash><span class=built_in>ls</span> -lsh /sys/class/infiniband/mlx5_0/ports/1/counters/</span></span><br><span class=line>total 0</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 excessive_buffer_overrun_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 link_downed</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 link_error_recovery</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 local_link_integrity_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 multicast_rcv_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 multicast_xmit_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_rcv_constraint_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_rcv_data</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_rcv_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_rcv_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_rcv_remote_physical_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_rcv_switch_relay_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_xmit_constraint_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_xmit_data</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_xmit_discards</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_xmit_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 port_xmit_wait</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 symbol_error</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 unicast_rcv_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 unicast_xmit_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 VL15_dropped</span><br></pre></td></tr></table></figure><p>Counter Description:</p><table><thead><tr><th align=left><strong>Counter</strong></th><th align=left><strong>Description</strong></th><th align=left><strong>InfiniBand Spec Name</strong></th><th align=left><strong>Group</strong></th></tr></thead><tbody><tr><td align=left>port_rcv_data</td><td align=left>The total number of data octets, divided by 4, (counting in double words, 32 bits), received on all VLs from the port.</td><td align=left>PortRcvData</td><td align=left>Informative</td></tr><tr><td align=left>port_rcv_packets</td><td align=left>Total number of packets (this may include packets containing Errors. This is 64 bit counter.</td><td align=left>PortRcvPkts</td><td align=left>Informative</td></tr><tr><td align=left>port_multicast_rcv_packets</td><td align=left>Total number of multicast packets, including multicast packets containing errors.</td><td align=left>PortMultiCastRcvPkts</td><td align=left>Informative</td></tr><tr><td align=left>port_unicast_rcv_packets</td><td align=left>Total number of unicast packets, including unicast packets containing errors.</td><td align=left>PortUnicastRcvPkts</td><td align=left>Informative</td></tr><tr><td align=left>port_xmit_data</td><td align=left>The total number of data octets, divided by 4, (counting in double words, 32 bits), transmitted on all VLs from the port.</td><td align=left>PortXmitData</td><td align=left>Informative</td></tr><tr><td align=left>port_xmit_packetsport_xmit_packets_64</td><td align=left>Total number of packets transmitted on all VLs from this port. This may include packets with errors.This is 64 bit counter.</td><td align=left>PortXmitPkts</td><td align=left>Informative</td></tr><tr><td align=left>port_rcv_switch_relay_errors</td><td align=left>Total number of packets received on the port that were discarded because they could not be forwarded by the switch relay.</td><td align=left>PortRcvSwitchRelayErrors</td><td align=left>Error</td></tr><tr><td align=left>port_rcv_errors</td><td align=left>Total number of packets containing an error that were received on the port.</td><td align=left>PortRcvErrors</td><td align=left>Informative</td></tr><tr><td align=left>port_rcv_constraint_errors</td><td align=left>Total number of packets received on the switch physical port that are discarded.</td><td align=left>PortRcvConstraintErrors</td><td align=left>Error</td></tr><tr><td align=left>local_link_integrity_errors</td><td align=left>The number of times that the count of local physical errors exceeded the threshold specified by LocalPhyErrors.</td><td align=left>LocalLinkIntegrityErrors</td><td align=left>Error</td></tr><tr><td align=left>port_xmit_wait</td><td align=left>The number of ticks during which the port had data to transmit but no data was sent during the entire tick (either because of insufficient credits or because of lack of arbitration).</td><td align=left>PortXmitWait</td><td align=left>Informative</td></tr><tr><td align=left>port_multicast_xmit_packets</td><td align=left>Total number of multicast packets transmitted on all VLs from the port. This may include multicast packets with errors.</td><td align=left>PortMultiCastXmitPkts</td><td align=left>Informative</td></tr><tr><td align=left>port_unicast_xmit_packets</td><td align=left>Total number of unicast packets transmitted on all VLs from the port. This may include unicast packets with errors.</td><td align=left>PortUnicastXmitPkts</td><td align=left>Informative</td></tr><tr><td align=left>port_xmit_discards</td><td align=left>Total number of outbound packets discarded by the port because the port is down or congested.</td><td align=left>PortXmitDiscards</td><td align=left>Error</td></tr><tr><td align=left>port_xmit_constraint_errors</td><td align=left>Total number of packets not transmitted from the switch physical port.</td><td align=left>PortXmitConstraintErrors</td><td align=left>Error</td></tr><tr><td align=left>port_rcv_remote_physical_errors</td><td align=left>Total number of packets marked with the EBP delimiter received on the port.</td><td align=left>PortRcvRemotePhysicalErrors</td><td align=left>Error</td></tr><tr><td align=left>symbol_error</td><td align=left>Total number of minor link errors detected on one or more physical lanes.</td><td align=left>SymbolErrorCounter</td><td align=left>Error</td></tr><tr><td align=left>VL15_dropped</td><td align=left>Number of incoming VL15 packets dropped due to resource limitations (e.g., lack of buffers) of the port.</td><td align=left>VL15Dropped</td><td align=left>Error</td></tr><tr><td align=left>link_error_recovery</td><td align=left>Total number of times the Port Training state machine has successfully completed the link error recovery process.</td><td align=left>LinkErrorRecoveryCounter</td><td align=left>Error</td></tr><tr><td align=left>link_downed</td><td align=left>Total number of times the Port Training state machine has failed the link error recovery process and downed the link.</td><td align=left>LinkDownedCounter</td><td align=left>Error</td></tr></tbody></table><h3 id=hw-counters><a href=#hw-counters class=headerlink title=hw_counters></a>hw_counters</h3><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash><span class=built_in>ls</span> -lsh /sys/class/infiniband/mlx5_0/ports/1/hw_counters/</span></span><br><span class=line>total 0</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 duplicate_request</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 implied_nak_seq_err</span><br><span class=line>0 -rw-r--r-- 1 root root 4.0K 5月  28 16:42 lifespan</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 local_ack_timeout_err</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 np_cnp_sent</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 np_ecn_marked_roce_packets</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 out_of_buffer</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 out_of_sequence</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 packet_seq_err</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 req_cqe_error</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 req_cqe_flush_error</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 req_remote_access_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 req_remote_invalid_request</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 resp_cqe_error</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 resp_cqe_flush_error</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 resp_local_length_error</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 resp_remote_access_errors</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rnr_nak_retry_err</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rp_cnp_handled</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rp_cnp_ignored</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rx_atomic_requests</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rx_icrc_encapsulated</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rx_read_requests</span><br><span class=line>0 -r--r--r-- 1 root root 4.0K 5月  24 15:28 rx_write_requests</span><br></pre></td></tr></table></figure><p>HW Counters Description:</p><table><thead><tr><th align=left><strong>Counter</strong></th><th align=left><strong>Description</strong></th><th align=left><strong>Group</strong></th></tr></thead><tbody><tr><td align=left>duplicate_request</td><td align=left>Number of received packets. A duplicate request is a request that had been previously executed.</td><td align=left>Error</td></tr><tr><td align=left>implied_nak_seq_err</td><td align=left>Number of time the requested decided an ACK. with a PSN larger than the expected PSN for an RDMA read or response.</td><td align=left>Error</td></tr><tr><td align=left>lifespan</td><td align=left>The maximum period in ms which defines the aging of the counter reads. Two consecutive reads within this period might return the same values</td><td align=left>Informative</td></tr><tr><td align=left>local_ack_timeout_err</td><td align=left>The number of times QP’s ack timer expired for RC, XRC, DCT QPs at the sender side.The QP retry limit was not exceed, therefore it is still recoverable error.</td><td align=left>Error</td></tr><tr><td align=left>np_cnp_sent</td><td align=left>The number of CNP packets sent by the Notification Point when it noticed congestion experienced in the RoCEv2 IP header (ECN bits).The counters was added in MLNX_OFED 4.1</td><td align=left>Informative</td></tr><tr><td align=left>np_ecn_marked_roce_packets</td><td align=left>The number of RoCEv2 packets received by the notification point which were marked for experiencing the congestion (ECN bits where ‘11’ on the ingress RoCE traffic) .The counters was added in MLNX_OFED 4.1</td><td align=left>Informative</td></tr><tr><td align=left>out_of_buffer</td><td align=left>The number of drops occurred due to lack of WQE for the associated QPs.</td><td align=left>Error</td></tr><tr><td align=left>out_of_sequence</td><td align=left>The number of out of sequence packets received.</td><td align=left>Error</td></tr><tr><td align=left>packet_seq_err</td><td align=left>The number of received NAK sequence error packets. The QP retry limit was not exceeded.</td><td align=left>Error</td></tr><tr><td align=left>req_cqe_error</td><td align=left>The number of times requester detected CQEs completed with errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>req_cqe_flush_error</td><td align=left>The number of times requester detected CQEs completed with flushed errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>req_remote_access_errors</td><td align=left>The number of times requester detected remote access errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>req_remote_invalid_request</td><td align=left>The number of times requester detected remote invalid request errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>resp_cqe_error</td><td align=left>The number of times responder detected CQEs completed with errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>resp_cqe_flush_error</td><td align=left>The number of times responder detected CQEs completed with flushed errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>resp_local_length_error</td><td align=left>The number of times responder detected local length errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>resp_remote_access_errors</td><td align=left>The number of times responder detected remote access errors.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>rnr_nak_retry_err</td><td align=left>The number of received RNR NAK packets. The QP retry limit was not exceeded.</td><td align=left>Error</td></tr><tr><td align=left>rp_cnp_handled</td><td align=left>The number of CNP packets handled by the Reaction Point HCA to throttle the transmission rate.The counters was added in MLNX_OFED 4.1</td><td align=left>Informative</td></tr><tr><td align=left>rp_cnp_ignored</td><td align=left>The number of CNP packets received and ignored by the Reaction Point HCA. This counter should not raise if RoCE Congestion Control was enabled in the network. If this counter raise, verify that ECN was enabled on the adapter. See <span class=exturl data-url="aHR0cHM6Ly9jb21tdW5pdHkubWVsbGFub3guY29tL3MvYXJ0aWNsZS9ob3d0by1jb25maWd1cmUtZGNxY24tLXJvY2UtY2MtLXZhbHVlcy1mb3ItY29ubmVjdHgtNC0tbGludXgteA==">HowTo Configure DCQCN (RoCE CC) values for ConnectX-4 (Linux)<i class="fa fa-external-link-alt"></i></span>.The counters was added in MLNX_OFED 4.1</td><td align=left>Error</td></tr><tr><td align=left>rx_atomic_requests</td><td align=left>The number of received ATOMIC request for the associated QPs.</td><td align=left>Informative</td></tr><tr><td align=left>rx_dct_connect</td><td align=left>The number of received connection request for the associated DCTs.</td><td align=left>Informative</td></tr><tr><td align=left>rx_read_requests</td><td align=left>The number of received READ requests for the associated QPs.</td><td align=left>Informative</td></tr><tr><td align=left>rx_write_requests</td><td align=left>The number of received WRITE requests for the associated QPs.</td><td align=left>Informative</td></tr><tr><td align=left>rx_icrc_encapsulated</td><td align=left>The number of RoCE packets with ICRC errors.This counter was added in MLNX_OFED 4.4 and kernel 4.19</td><td align=left>Error</td></tr><tr><td align=left>roce_adp_retrans</td><td align=left>Counts the number of adaptive retransmissions for RoCE trafficThe counter was added in MLNX_OFED rev 5.0-1.0.0.0 and kernel v5.6.0</td><td align=left>Informative</td></tr><tr><td align=left>roce_adp_retrans_to</td><td align=left>Counts the number of times RoCE traffic reached timeout due to adaptive retransmissionThe counter was added in MLNX_OFED rev 5.0-1.0.0.0 and kernel v5.6.0</td><td align=left>Informative</td></tr><tr><td align=left>roce_slow_restart</td><td align=left>Counts the number of times RoCE slow restart was usedThe counter was added in MLNX_OFED rev 5.0-1.0.0.0 and kernel v5.6.0</td><td align=left>Informative</td></tr><tr><td align=left>roce_slow_restart_cnps</td><td align=left>Counts the number of times RoCE slow restart generated CNP packetsThe counter was added in MLNX_OFED rev 5.0-1.0.0.0 and kernel v5.6.0</td><td align=left>Informative</td></tr><tr><td align=left>roce_slow_restart_trans</td><td align=left>Counts the number of times RoCE slow restart changed state to slow restartThe counter was added in MLNX_OFED rev 5.0-1.0.0.0 and kernel v5.6.0</td><td align=left>Informative</td></tr></tbody></table><ul><li><code>duplicate_request</code>:（Duplicated packets）接收报文数，重复请求是先前已执行的请求。</li><li><code>out_of_sequence</code>:（Drop out of sequence）接收到的乱序包的数量，说明此时已经产生了丢包</li><li><code>packet_seq_err</code>：（NAK sequence rcvd）接收到的NAK序列错误数据包的数量，未超过QP重试限制。</li></ul><h2 id=带宽监测工具——netdata><a href=#带宽监测工具——netdata class=headerlink title=带宽监测工具——netdata></a>带宽监测工具——netdata</h2><p><code>netdata</code>可以查看RDMA网卡的带宽，但是展示的发送和接收的数据是通过<code>/sys/class/infiniband</code>下的节点获取的，因此实际带宽数据是其展示数据的<code>4倍</code></p><p><img data-src=/images/2021/05/netdata_rdma_ib.png alt=netdata_rdma_ib></p><blockquote><p>插件源码：<span class=exturl data-url="aHR0cHM6Ly9naXRodWIuY29tL25ldGRhdGEvbmV0ZGF0YS9ibG9iL21hc3Rlci9jb2xsZWN0b3JzL3Byb2MucGx1Z2luL3N5c19jbGFzc19pbmZpbmliYW5kLmM=">https://github.com/netdata/netdata/blob/master/collectors/proc.plugin/sys_class_infiniband.c<i class="fa fa-external-link-alt"></i></span></p></blockquote><h2 id=网卡工作模式><a href=#网卡工作模式 class=headerlink title=网卡工作模式></a>网卡工作模式</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><span class=line><span class="meta prompt_"># </span><span class=language-bash>ibstatus</span></span><br><span class=line>Infiniband device &#x27;mlx5_0&#x27; port 1 status:</span><br><span class=line>	default gid:	 fe80:0000:0000:0000:0e42:a1ff:fe41:2d36</span><br><span class=line>	base lid:	 0x0</span><br><span class=line>	sm lid:		 0x0</span><br><span class=line>	state:		 4: ACTIVE</span><br><span class=line>	phys state:	 5: LinkUp</span><br><span class=line>	rate:		 25 Gb/sec (1X EDR)</span><br><span class=line>	link_layer:	 Ethernet</span><br><span class=line></span><br><span class=line>Infiniband device &#x27;mlx5_1&#x27; port 1 status:</span><br><span class=line>	default gid:	 fe80:0000:0000:0000:0e42:a1ff:fe41:2d37</span><br><span class=line>	base lid:	 0x0</span><br><span class=line>	sm lid:		 0x0</span><br><span class=line>	state:		 4: ACTIVE</span><br><span class=line>	phys state:	 5: LinkUp</span><br><span class=line>	rate:		 25 Gb/sec (1X EDR)</span><br><span class=line>	link_layer:	 Ethernet</span><br></pre></td></tr></table></figure><ul><li><code>link_layer</code>： 工作模式，Ethernet为IP模式，还有IB（infiniband）模式。</li><li>工作模式切换：<span class=exturl data-url="aHR0cHM6Ly9jb21tdW5pdHkubWVsbGFub3guY29tL3MvYXJ0aWNsZS9ob3d0by1jaGFuZ2UtcG9ydC10eXBlLWluLW1lbGxhbm94LWNvbm5lY3R4LTMtYWRhcHRlcg==">HowTo Change Port Type in Mellanox ConnectX-3 Adapter<i class="fa fa-external-link-alt"></i></span></li></ul><h2 id=常用命令><a href=#常用命令 class=headerlink title=常用命令></a>常用命令</h2><ul><li><code>ibstat</code>: 查询InfiniBand设备的基本状态</li><li><code>ibstatus</code>： 网卡信息</li><li><code>ibv_devinfo</code>：网卡设备信息（ibv_devinfo -d mlx5_0 -v）</li><li><code>ibv_devices</code>：查看本主机的infiniband设备</li><li><code>ibnodes</code>：查看网络中的infiniband设备</li><li><code>show_gids</code>：看看网卡支持的roce版本</li><li><code>show_counters</code>:网卡端口统计数据，比如发送接受数据大小</li><li><code>mlxconfig</code>: 网卡配置（mlxconfig -d mlx5_1 q查询网卡配置信息）</li></ul><h2 id=双网口作用><a href=#双网口作用 class=headerlink title=双网口作用></a>双网口作用</h2><p><code>双网口</code>：指一个物理网卡上的两个网络接口</p><ol><li>可以捆绑，比单口效率高多了。同时上两个不同的网络网，有一个不同时，另一个也在同时工作实现网络备份。</li><li>服务器必备2个或2个以上的网口，一个用于网路接入，另一个作为输入。</li><li>家用PC机用2个的网口的网卡，可以实现服务器的初级功能，接入网络然后输入，并管理输入端的网路和数据。</li><li>双口的可以做负载均衡，单口的无此功能。</li><li>双口的可以连接两个网络，可以做网关，单口的直接无法做到此点。当然，如果用两个单口网卡，也可以实现某些双口网卡的同样效果，但在转换速度上还是和双口网卡略有差异。</li></ol><h2 id=参考><a href=#参考 class=headerlink title=参考></a>参考</h2><ul><li><span class=exturl data-url=aHR0cHM6Ly9hY2Nlc3MucmVkaGF0LmNvbS9zb2x1dGlvbnMvMzAxNjQz>How to install support for Mellanox Infiniband hardware on RHEL6<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url=aHR0cHM6Ly93d3cubWVsbGFub3guY29tL3N1cHBvcnQvbWxueC1vZmVkLXB1YmxpYy1yZXBvc2l0b3J5>Mellanox Technologies Ltd. Public Repository<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h6dGpocy9hcnRpY2xlL2RldGFpbHMvNTE0ODc0Njc=">infiniband带宽测试方法1 ib_read&#x2F;write_bw&#x2F;lat<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xqbGZhdGhlci9hcnRpY2xlL2RldGFpbHMvMTAyOTI1OTU0>ib_write_bw 和 ib_read_bw 测试 RDMA 的读写处理确定带宽<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1FpYW5nTGlfc3Ryb25nL2FydGljbGUvZGV0YWlscy84MTAyMTE5Mw==">ibverbs文档翻译<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly9pbnN1amFuZy5naXRodWIuaW8vMjAyMC0wMi0wOS9pbnRyb2R1Y3Rpb24tdG8tcHJvZ3JhbW1pbmctaW5maW5pYmFuZC8=">Introduction to Programming Infiniband RDMA<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url=aHR0cHM6Ly9kYXRhdHJhY2tlci5pZXRmLm9yZy9kb2MvaHRtbC9kcmFmdC10YWxwZXktbmZzdjQtcmRtYS1zZXNzLTAw>NFSv4 RDMA and Session Extensions<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url=aHR0cHM6Ly93d3cubWVsbGFub3guY29tL3JlbGF0ZWQtZG9jcy9wcm9kX3NvZnR3YXJlL1JETUFfQXdhcmVfUHJvZ3JhbW1pbmdfdXNlcl9tYW51YWwucGRm>RDMA_Aware_Programming_user_manual.pdf<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vc2N0Yi9wLzEzMTc5NTQyLmh0bWw=">infiniband网卡安装、使用总结<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly9kb2NzLm1lbGxhbm94LmNvbS9kaXNwbGF5L1ZNQXY4ODMvUG9ydCtUeXBlK01hbmFnZW1lbnQ=">Port Type Management<i class="fa fa-external-link-alt"></i></span></li></ul></div><footer class=post-footer><div class=post-copyright><ul><li class=post-copyright-author><strong>本文作者：</strong>winddoing</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://winddoing.github.io/post/f4fa9e36.html title=RDMA网络简介>https://winddoing.github.io/post/f4fa9e36.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <span class=exturl data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class=post-tags><a href="/tags/%E7%BD%91%E7%BB%9C/" rel=tag><i class="fa fa-tag"></i> 网络</a> <a href="/tags/rdma/" rel=tag><i class="fa fa-tag"></i> rdma</a></div><div class=post-nav><div class=post-nav-item><a href=/post/851846f4.html rel=prev title="`GLIBCXX_3.4.21' not found"><i class="fa fa-chevron-left"></i> `GLIBCXX_3.4.21' not found</a></div><div class=post-nav-item><a href=/post/c9919005.html rel=next title=基于bonding实现网卡聚合>基于bonding实现网卡聚合 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2014 – <span itemprop=copyrightYear>2023</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>winddoing</span></div><div class=wordcount><span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-chart-line"></i></span> <span title=站点总字数>1.1m</span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span title=站点阅读时长>16:21</span></span></div><div class=busuanzi-count><span class=post-meta-item id=busuanzi_container_site_uv><span class=post-meta-item-icon><i class="fa fa-users"></i></span> <span class=site-uv title=总访客量><span id=busuanzi_value_site_uv></span></span></span> <span class=post-meta-item id=busuanzi_container_site_pv><span class=post-meta-item-icon><i class="fa fa-eye"></i></span> <span class=site-pv title=总访问量><span id=busuanzi_value_site_pv></span></span></span></div><div class=powered-by>由 <span class=exturl data-url=aHR0cHM6Ly9oZXhvLmlv>Hexo</span> & <span class=exturl data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9taXN0Lw==">NexT.Mist</span> 强力驱动</div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script class=next-config data-name=pdf type=application/json>{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src=/js/third-party/tags/pdf.js></script><script class=next-config data-name=mermaid type=application/json>{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js","integrity":"sha256-8L3O8tirFUa8Va4NSTAyIbHJeLd6OnlcxgupV9F77e0="}}</script><script src=/js/third-party/tags/mermaid.js></script><script src=/js/third-party/fancybox.js></script><script data-pjax async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script class=next-config data-name=leancloud_visitors type=application/json>{"enable":true,"app_id":"Q8qpjA3fOO7FEUBqcmcQFptF-gzGzoHsz","app_key":"tgUTq5bX3fVmn916EMRe65eJ","server_url":null,"security":false}</script><script src=/js/third-party/statistics/lean-analytics.js></script><script class=next-config data-name=enableMath type=application/json>false</script><script class=next-config data-name=mathjax type=application/json>{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.js","integrity":"sha256-hlC2uSQYTmPsrzGZTEQEg9PZ1a/+SV6VBCTclohf2og="}}</script><script src=/js/third-party/math/mathjax.js></script><script class=next-config data-name=utterances type=application/json>{"enable":true,"repo":"Winddoing/winddoing.github.io","issue_term":"title","theme":"github-light"}</script><script src=/js/third-party/comments/utterances.js></script></body></html>