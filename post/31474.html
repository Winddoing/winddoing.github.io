<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=#222 media="(prefers-color-scheme: light)"><meta name=theme-color content=#222 media="(prefers-color-scheme: dark)"><meta name=generator content="Hexo 6.2.0"><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preconnect href=https://cdnjs.cloudflare.com crossorigin><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon.ico><link rel=mask-icon href=/images/logo.svg color=#222><meta name=baidu-site-verification content=WIIeufYjj6><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Microsoft+YaHei:300,300italic,400,400italic,700,700italic%7Ccmmi10:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><script class=next-config data-name=main type=application/json>{"hostname":"winddoing.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.12.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content=Boost.Asio是用于网络和低层IO编程的跨平台C++库,为开发者提供了C++环境下稳定的异步模型。><meta property=og:type content=article><meta property=og:title content="boost asio for anbox"><meta property=og:url content=https://winddoing.github.io/post/31474.html><meta property=og:site_name content="Winddoing&#39;s Notes"><meta property=og:description content=Boost.Asio是用于网络和低层IO编程的跨平台C++库,为开发者提供了C++环境下稳定的异步模型。><meta property=og:locale content=zh_CN><meta property=og:image content=https://winddoing.github.io/images/2020/02/asio_socket_sync.png><meta property=og:image content=https://winddoing.github.io/images/2020/02/asio_socket_async.png><meta property=og:image content=https://winddoing.github.io/images/2020/02/asio_io_service.png><meta property=article:published_time content=2020-02-25T09:15:00.000Z><meta property=article:modified_time content=2023-12-16T04:58:17.929Z><meta property=article:author content=winddoing><meta property=article:tag content=anbox><meta property=article:tag content=数据传输><meta property=article:tag content=c++><meta property=article:tag content=asio><meta name=twitter:card content=summary><meta name=twitter:image content=https://winddoing.github.io/images/2020/02/asio_socket_sync.png><link rel=canonical href=https://winddoing.github.io/post/31474.html><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://winddoing.github.io/post/31474.html","path":"post/31474.html","title":"boost asio for anbox"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>boost asio for anbox | Winddoing's Notes</title><script src=/js/third-party/analytics/baidu-analytics.js></script><script async src=https://hm.baidu.com/hm.js?b96a560ce0a6bfbeaaddc59dc5888b75></script><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href="/" class=brand rel=start><i class=logo-line></i><p class=site-title>Winddoing's Notes</p><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Follow Excellent, Success will Chase you</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#IO%E6%A8%A1%E5%9E%8B><span class=nav-number>1.</span> <span class=nav-text>IO模型</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%90%8C%E6%AD%A5IO%E5%A4%84%E7%90%86><span class=nav-number>1.1.</span> <span class=nav-text>同步IO处理</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%BC%82%E6%AD%A5IO%E5%A4%84%E7%90%86><span class=nav-number>1.2.</span> <span class=nav-text>异步IO处理</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#%E5%B8%B8%E7%94%A8%E6%8E%A5%E5%8F%A3><span class=nav-number>1.3.</span> <span class=nav-text>常用接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class=nav-link href=#boost-asio-io-service><span class=nav-number>2.</span> <span class=nav-text>boost::asio::io_service</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#Anbox-IO%E6%A8%A1%E5%9E%8B><span class=nav-number>3.</span> <span class=nav-text>Anbox IO模型</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%8F%82%E8%80%83><span class=nav-number>4.</span> <span class=nav-text>参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=winddoing src=/images/Winddoing.jpg><p class=site-author-name itemprop=name>winddoing</p><div class=site-description itemprop=description>失败缘于忽视细处，成功始于重视小事</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>358</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>112</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>284</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9naXRodWIuY29tL1dpbmRkb2luZw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Winddoing"><i class="fab fa-github fa-fw"></i>GitHub</span></span> <span class=links-of-author-item><span class=exturl data-url=aHR0cHM6Ly9naXRlZS5jb20vd2luZGRvaW5n title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;winddoing"><i class="fab fa-codiepie fa-fw"></i>Gitee</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy85NTY3MzYxL3dpbmRkb2luZw==" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;9567361&#x2F;winddoing"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9hcHAudHJhdmlzLWNpLmNvbS9naXRodWIvV2luZGRvaW5nL3dpbmRkb2luZy5naXRodWIuaW8=" title="Travis CI → https:&#x2F;&#x2F;app.travis-ci.com&#x2F;github&#x2F;Winddoing&#x2F;winddoing.github.io"><i class="fas fa-terminal fa-fw"></i>Travis CI</span></span></div><div class="cc-license site-overview-item animated" itemprop=license><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg alt="Creative Commons"></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="link fa-fw"></i> Links</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cHM6Ly93aW5kZG9pbmcuZ2l0Ym9vay5pby9lbWJlZGRlZF9saW51eF9ub3Rlcy8=" title=https:&#x2F;&#x2F;winddoing.gitbook.io&#x2F;embedded_linux_notes&#x2F;>嵌入式相关</span></li><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2RyZWFtcQ==" title=http:&#x2F;&#x2F;blog.csdn.net&#x2F;sdreamq>CSDN</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cDovL3d3dy53b3dvdGVjaC5uZXQv title=http:&#x2F;&#x2F;www.wowotech.net&#x2F;>蜗窝科技</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpb25neGlhbnpl title=https:&#x2F;&#x2F;blog.csdn.net&#x2F;xiongxianze>xiongxianze</span></li></ul></div><div id=days></div><script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("02/26/2014 15:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=https://winddoing.github.io/post/31474.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/Winddoing.jpg><meta itemprop=name content=winddoing></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Winddoing's Notes"><meta itemprop=description content=失败缘于忽视细处，成功始于重视小事></span> <span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="boost asio for anbox | Winddoing's Notes"><meta itemprop=description></span><header class=post-header><h1 class=post-title itemprop="name headline">boost asio for anbox</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2020-02-25 17:15:00" itemprop="dateCreated datePublished" datetime=2020-02-25T17:15:00+08:00>2020-02-25</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/" itemprop=url rel=index><span itemprop=name>程序设计</span></a></span> ， <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/C/" itemprop=url rel=index><span itemprop=name>C++</span></a></span></span> <span id=/post/31474.html class="post-meta-item leancloud_visitors" data-flag-title="boost asio for anbox" title=阅读次数><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span class=leancloud-visitors-count></span></span> <span class=post-meta-item title=阅读次数 id=busuanzi_container_page_pv><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span></span> <span class=post-meta-break></span> <span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>4.8k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><p>Boost.Asio是用于<code>网络</code>和<code>低层IO</code>编程的跨平台C++库,为开发者提供了C++环境下稳定的<code>异步模型</code>。</p><span id=more></span><h2 id=IO模型><a href=#IO模型 class=headerlink title=IO模型></a>IO模型</h2><p><code>io_service</code>对象是asio框架中的<code>调度器</code>，所有异步io事件都是通过它来分发处理的（io对象的构造函数中都需要传入一个io_service对象）, 其提供着是一个<code>生产者消费者模型</code>。<br><code>io_service</code>类在多线程编程模型中提供了任务队列和任务分发功能,最常用的接口：<code>run</code>、<code>post</code>、<code>stop</code></p><figure class="highlight c++"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>boost::asio::io_service io_service;</span><br><span class=line>boost::asio::ip::<span class=function>tcp::socket <span class=title>socket</span><span class=params>(io_service)</span></span>;</span><br></pre></td></tr></table></figure><h3 id=同步IO处理><a href=#同步IO处理 class=headerlink title=同步IO处理></a>同步IO处理</h3><p><img data-src=/images/2020/02/asio_socket_sync.png alt=asio_socket_sync></p><ol><li>应用程序调用IO对象成员函数执行IO操作</li><li>IO对象向io_service 提出请求.</li><li>io_service 调用操作系统的功能<code>执行连接</code>操作.</li><li>操作系统向io_service 返回执行结果.</li><li>io_service将错误的操作结果翻译为boost::system::error_code类型，再传递给IO对象.</li><li>如果操作失败,IO对象抛出boost::system::system_error类型的异常.</li></ol><h3 id=异步IO处理><a href=#异步IO处理 class=headerlink title=异步IO处理></a>异步IO处理</h3><p><img data-src=/images/2020/02/asio_socket_async.png alt=asio_socket_async></p><ol><li>应用程序调用IO对象成员函数执行IO操作</li><li>IO对象请求io_service的服务</li><li>io_service 通知操作系统其需要开始一个<code>异步连接</code>操作.</li><li>操作系统指示连接操作完成, io_service从队列中获取操作结果</li><li>应用程序必须调用io_service::run()以便于接收结果</li><li>调用io_service::run()后,io_service返回一个操作结果,并将其翻译为error_code,传递到事件回调函数中</li></ol><h3 id=常用接口><a href=#常用接口 class=headerlink title=常用接口></a>常用接口</h3><ul><li>post</li></ul><p>post用于发布io事件，如timer，socket读写等，一般由asio框架相应对象调用，无需我们显式调用。</p><ul><li>run</li></ul><p>run用于<code>监听io事件</code>响应，并执行响应回调，对于异步io操作需要在代码中显式调用，对于同步io操作则由io对象隐式调用（并不是run函数，不过也是等待io事件）。</p><h2 id=boost-asio-io-service><a href=#boost-asio-io-service class=headerlink title=boost::asio::io_service></a>boost::asio::io_service</h2><p><code>io_service</code>类在多线程编程里面提供了<code>任务队列</code>和<code>任务分发</code>功能，在socket、io编程里主要作为一个事件驱动器(完成端口、select、poll、epoll等)。</p><p><img data-src=/images/2020/02/asio_io_service.png alt=asio_io_service></p><blockquote><p><code>io_service</code>都一个公有任务队列，和多个私有任务队列，公有队列由各个线程共享，私有队列则是每个线程独享</p></blockquote><ol><li>调用run方法，进入主loop；</li><li>判断公有队列是否为空，不为空则取出任务并执行，当任务数大于1时同时唤醒其他空闲线程；</li><li>任务执行结束，把各个线程的私有队里面的任务移动到公有任务队列里面；</li><li>触发reactor，linux下面一般是<code>epoll</code>，当有事件时，把相应的事件的任务放到私有队列里。</li><li>当队列为空时，把当前线程加到空闲线程队列里面，同时进入wait状态，等待其他线程的唤醒（task_operation）。</li><li>当用户调用post时，任务是直接投递到公有队列op_queue里面。</li></ol><h2 id=Anbox-IO模型><a href=#Anbox-IO模型 class=headerlink title="Anbox IO模型"></a>Anbox IO模型</h2><p>Anbox 的 I&#x2F;O 模型基于 boost.asio 构建。Anbox 中所有的 I&#x2F;O 事件，在一个线程池中，通过一个<code>boost::asio::io_service</code>对象来派发并处理。Anbox 用<code>anbox::Runtime</code>类封装一个 <code>boost::asio::io_service</code>对象，并管理执行任务的<code>线程池</code>。</p><figure class="highlight c++"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br></pre></td><td class=code><pre><span class=line><span class=keyword>namespace</span> anbox &#123;</span><br><span class=line><span class=comment>// We bundle our &quot;global&quot; runtime dependencies here, specifically</span></span><br><span class=line><span class=comment>// a dispatcher to decouple multiple in-process providers from one</span></span><br><span class=line><span class=comment>// another , forcing execution to a well known set of threads.</span></span><br><span class=line><span class=keyword>class</span> <span class="title class_">Runtime</span> : <span class=keyword>public</span> DoNotCopyOrMove,</span><br><span class=line>                <span class=keyword>public</span> std::enable_shared_from_this&lt;Runtime&gt; &#123;</span><br><span class=line> <span class=keyword>public</span>:</span><br><span class=line>  <span class=comment>// Our default concurrency setup.</span></span><br><span class=line>  <span class=type>static</span> <span class=keyword>constexpr</span> <span class=type>const</span> std::<span class=type>uint32_t</span> worker_threads = <span class=number>8</span>;</span><br><span class=line>  <span class=comment>// create returns a Runtime instance with pool_size worker threads</span></span><br><span class=line>  <span class=comment>// executing the underlying service.</span></span><br><span class=line>  <span class=function><span class=type>static</span> std::shared_ptr&lt;Runtime&gt; <span class=title>create</span><span class=params>(</span></span></span><br><span class=line><span class=params><span class=function>      std::<span class=type>uint32_t</span> pool_size = worker_threads)</span></span>;</span><br><span class=line>  <span class=comment>// Tears down the runtime, stopping all worker threads.</span></span><br><span class=line>  ~<span class=built_in>Runtime</span>() <span class=built_in>noexcept</span>(<span class=literal>true</span>);</span><br><span class=line>  <span class=comment>// start executes the underlying io_service on a thread pool with</span></span><br><span class=line>  <span class=comment>// the size configured at creation time.</span></span><br><span class=line>  <span class=function><span class=type>void</span> <span class=title>start</span><span class=params>()</span></span>;</span><br><span class=line>  <span class=comment>// stop cleanly shuts down a Runtime instance.</span></span><br><span class=line>  <span class=function><span class=type>void</span> <span class=title>stop</span><span class=params>()</span></span>;</span><br><span class=line>  <span class=comment>// to_dispatcher_functional returns a function for integration</span></span><br><span class=line>  <span class=comment>// with components that expect a dispatcher for operation.</span></span><br><span class=line>  std::function&lt;<span class=type>void</span>(std::function&lt;<span class=type>void</span>()&gt;)&gt; <span class=built_in>to_dispatcher_functional</span>();</span><br><span class=line>  <span class=comment>// service returns the underlying boost::asio::io_service that is executed</span></span><br><span class=line>  <span class=comment>// by the Runtime.</span></span><br><span class=line>  boost::<span class=function>asio::io_service&amp; <span class=title>service</span><span class=params>()</span></span>;</span><br><span class=line> <span class=keyword>private</span>:</span><br><span class=line>  <span class=comment>// Runtime constructs a new instance, firing up pool_size</span></span><br><span class=line>  <span class=comment>// worker threads.</span></span><br><span class=line>  <span class=built_in>Runtime</span>(std::<span class=type>uint32_t</span> pool_size);</span><br><span class=line>  std::<span class=type>uint32_t</span> pool_size_;</span><br><span class=line>  boost::asio::io_service service_;</span><br><span class=line>  boost::asio::io_service::strand strand_;</span><br><span class=line>  boost::asio::io_service::work keep_alive_;</span><br><span class=line>  std::vector&lt;std::thread&gt; workers_;</span><br><span class=line>&#125;;</span><br><span class=line>&#125;  <span class=comment>// namespace anbox</span></span><br></pre></td></tr></table></figure><blockquote><p>file: anbox&#x2F;src&#x2F;anbox&#x2F;runtime.h</p></blockquote><p><code>anbox::Runtime</code> 类封装了一个 <code>boost::asio::io_service</code> 对象及多个工作线程 <code>std::thread</code>，它还继承 <code>std::enable_shared_from_this</code> 以获得从 <code>this</code> 指针创建智能指针 <code>std::shared_ptr</code> 的能力，同时继承了 <code>DoNotCopyOrMove</code>，以禁掉类的拷贝和移动操作。</p><p><code>anbox::Runtime</code> 类有两大职责:</p><ul><li>一是 <code>boost::asio::io_service</code> 对象的生命周期管理；</li><li>二是向 <code>boost::asio::io_service</code> 中提交任务。</li></ul><p>在 <code>anbox::Runtime::start()</code> 函数中创建并启动多个线程，执行一个执行 <code>boost::asio::io_service::run()</code> 函数的函数 <code>exception_safe_run()</code>。在 <code>anbox::Runtime::stop()</code> 函数中停掉 <code>boost::asio::io_service</code> 的执行。<code>anbox::Runtime</code> 的析够函数中，还会调用 <code>stop()</code> 函数停掉 <code>boost::asio::io_service</code> 的执行。<code>anbox::Runtime</code> 的类型为 <code>boost::asio::io_service::work</code> 的成员变量 <code>keep_alive_</code> 也是用于管理 <code>boost::asio::io_service</code> 对象的生命周期的，该对象在析够时也会停掉 <code>boost::asio::io_service</code> 的执行。</p><p>Anbox 的 I&#x2F;O 模型可以理解为，底层有一个多路复用器或事件循环 <code>boost::asio::io_service</code>，有一个包含了 8 个线程的线程池基于此 <code>boost::asio::io_service</code> 运行，处理 I&#x2F;O 事件及其它各种类型的任务。</p><p>Anbox 需要处理如下这样一些网络 I&#x2F;O 过程：</p><ul><li>监听 Unix 域 Socket 接受连接。Anbox 的 SessionManager 通过 Unix 域 Socket 与 ContainerManager 进行通信，同时也通过 Unix 域 Socket 与 ContainerManager 启动的 Android 容器内的应用程序通信。首先 ContainerManager 监听在特定位置的 Unix 域 Socket 上。随后 SessionManager 监听几个位置上的 Unix 域 Socket，然后请求 ContainerManager 启动 Android 容器，并将这几个 Unix 域 Socket 映射到容器内的 <code>/dev/</code> 目录下。Android 容器启动后，一些进程，如 surfaceflinger、cameraservice 等连接这些 Unix 域 Socket，并通过这些 Unix 域 Socket 与 SessionManager 通信，进而操作宿主机的硬件设备。</li><li>监听 TCP Socket 接受连接。Anbox 的 SessionManager 作为容器中运行的 Android 与 ADB 进行通信的桥梁，它在与容器中运行的 Android 通过 Unix 域 Socket 通信的同时，也需要与宿主机上的 ADB 通信。SessionManager 通过 TCP 与宿主机上的 ADB 守护进程通信。如同模拟器等 Android 设备一样，SessionManager 遵从 ADB 的通信协议，在发起与 ADB 之间的 TCP 连接的同时，也需要监听一个 TCP 端口，等待 ADB 守护进程发起的连接，以完成整个 ADB 协议。</li><li>处理从监听的 Unix 域 Socket 接受的 Unix 域 Socket。监听的 Unix 域 Socket 接受新连接之后，需要将新创建的 Unix 域 Socket 提交给底层的 I&#x2F;O 多路复用器，并为该 Socket 提供读写等 I&#x2F;O 事件处理处理回调，以完成 Anbox 的应用逻辑。</li><li>处理从监听的 TCP Scoket 接受的 TCP Socket。监听的 TCP Socket 接受新连接之后，需要将新创建的 TCP Socket 提交给底层的 I&#x2F;O 多路复用器，并为该 Socket 提供读写等 I&#x2F;O 事件处理处理回调，以完成 Anbox 的应用逻辑。</li><li>发起一个到 TCP 服务器的连接。如前面提到的，Anbox 的 SessionManager 通过 TCP 连接与 ADB 守护进程通信，它会先发起一个到 ADB 守护进程的 TCP 连接。</li><li>发起一个到 Unix 域 Socket 服务的连接。Anbox 的 SessionManager 与 ContainerManager 之间通过 Unix 域 Socket 通信，SessionManager 会发起到 ContainerManager 监听的 Unix 域 Socket 服务的连接。</li></ul><h2 id=参考><a href=#参考 class=headerlink title=参考></a>参考</h2><ul><li><span class=exturl data-url="aHR0cDovL2NoYXJldHRlLm5vLWlwLmNvbTo4MS9wcm9ncmFtbWluZy9kb3h5Z2VuL2Jvb3N0L2NsYXNzYm9vc3RfMV8xYXNpb18xXzFpb19fc2VydmljZV8xXzFzdHJhbmQuaHRtbA==">boost::asio::io_service::strand Class Reference<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly93d3cuYm9vc3Qub3JnL2RvYy9saWJzLzFfNzJfMC9kb2MvaHRtbC9ib29zdF9hc2lvLmh0bWw=">Boost.Asio<i class="fa fa-external-link-alt"></i></span></li><li><span class=exturl data-url="aHR0cHM6Ly9tbW9hYXkuZ2l0Ym9va3MuaW8vYm9vc3QtYXNpby1jcHAtbmV0d29yay1wcm9ncmFtbWluZy1jaGluZXNlL2NvbnRlbnQvQ2hhcHRlcjEuaHRtbA==">Boost.Asio入门<i class="fa fa-external-link-alt"></i></span></li></ul></div><footer class=post-footer><div class=post-copyright><ul><li class=post-copyright-author><strong>本文作者：</strong>winddoing</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://winddoing.github.io/post/31474.html title="boost asio for anbox">https://winddoing.github.io/post/31474.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <span class=exturl data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class=post-tags><a href="/tags/anbox/" rel=tag><i class="fa fa-tag"></i> anbox</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" rel=tag><i class="fa fa-tag"></i> 数据传输</a> <a href="/tags/c/" rel=tag><i class="fa fa-tag"></i> c++</a> <a href="/tags/asio/" rel=tag><i class="fa fa-tag"></i> asio</a></div><div class=post-nav><div class=post-nav-item><a href=/post/40085.html rel=prev title=win10家庭版设置软件安装密码——本地组策略编辑器><i class="fa fa-chevron-left"></i> win10家庭版设置软件安装密码——本地组策略编辑器</a></div><div class=post-nav-item><a href=/post/8528.html rel=next title="OpenGL之Sync Object">OpenGL之Sync Object <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2014 – <span itemprop=copyrightYear>2023</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>winddoing</span></div><div class=wordcount><span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-chart-line"></i></span> <span title=站点总字数>1.1m</span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span title=站点阅读时长>16:21</span></span></div><div class=busuanzi-count><span class=post-meta-item id=busuanzi_container_site_uv><span class=post-meta-item-icon><i class="fa fa-users"></i></span> <span class=site-uv title=总访客量><span id=busuanzi_value_site_uv></span></span></span> <span class=post-meta-item id=busuanzi_container_site_pv><span class=post-meta-item-icon><i class="fa fa-eye"></i></span> <span class=site-pv title=总访问量><span id=busuanzi_value_site_pv></span></span></span></div><div class=powered-by>由 <span class=exturl data-url=aHR0cHM6Ly9oZXhvLmlv>Hexo</span> & <span class=exturl data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9taXN0Lw==">NexT.Mist</span> 强力驱动</div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script class=next-config data-name=pdf type=application/json>{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src=/js/third-party/tags/pdf.js></script><script class=next-config data-name=mermaid type=application/json>{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js","integrity":"sha256-8L3O8tirFUa8Va4NSTAyIbHJeLd6OnlcxgupV9F77e0="}}</script><script src=/js/third-party/tags/mermaid.js></script><script src=/js/third-party/fancybox.js></script><script data-pjax async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script class=next-config data-name=leancloud_visitors type=application/json>{"enable":true,"app_id":"Q8qpjA3fOO7FEUBqcmcQFptF-gzGzoHsz","app_key":"tgUTq5bX3fVmn916EMRe65eJ","server_url":null,"security":false}</script><script src=/js/third-party/statistics/lean-analytics.js></script><script class=next-config data-name=enableMath type=application/json>false</script><script class=next-config data-name=mathjax type=application/json>{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.js","integrity":"sha256-hlC2uSQYTmPsrzGZTEQEg9PZ1a/+SV6VBCTclohf2og="}}</script><script src=/js/third-party/math/mathjax.js></script><script class=next-config data-name=utterances type=application/json>{"enable":true,"repo":"Winddoing/winddoing.github.io","issue_term":"title","theme":"github-light"}</script><script src=/js/third-party/comments/utterances.js></script></body></html>