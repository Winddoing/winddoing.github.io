<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=#222 media="(prefers-color-scheme: light)"><meta name=theme-color content=#222 media="(prefers-color-scheme: dark)"><meta name=generator content="Hexo 6.2.0"><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preconnect href=https://cdnjs.cloudflare.com crossorigin><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon.ico><link rel=mask-icon href=/images/logo.svg color=#222><meta name=baidu-site-verification content=WIIeufYjj6><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Microsoft+YaHei:300,300italic,400,400italic,700,700italic%7Ccmmi10:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><script class=next-config data-name=main type=application/json>{"hostname":"winddoing.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.12.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content=在ARM64中SP（栈指针），由于存在EL0～EL3四种异常级别，因此存在四个SP；但是PC指针只有一个（单核）><meta property=og:type content=article><meta property=og:title content=ARMv8异常处理><meta property=og:url content=https://winddoing.github.io/post/5c89cc1d.html><meta property=og:site_name content="Winddoing&#39;s Notes"><meta property=og:description content=在ARM64中SP（栈指针），由于存在EL0～EL3四种异常级别，因此存在四个SP；但是PC指针只有一个（单核）><meta property=og:locale content=zh_CN><meta property=og:image content=https://winddoing.github.io/images/2021/11/arm64_spec_regs.png><meta property=og:image content=https://winddoing.github.io/images/2021/11/arm64_exception_handling.png><meta property=og:image content=https://winddoing.github.io/images/2021/11/arm64%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AF%84%E5%AD%98%E5%99%A8.png><meta property=og:image content=https://winddoing.github.io/images/2021/11/arm64%E5%BC%82%E5%B8%B8%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png><meta property=article:published_time content=2021-11-22T02:04:00.000Z><meta property=article:modified_time content=2023-12-16T04:58:17.921Z><meta property=article:author content=winddoing><meta property=article:tag content=arm64><meta property=article:tag content=异常处理><meta name=twitter:card content=summary><meta name=twitter:image content=https://winddoing.github.io/images/2021/11/arm64_spec_regs.png><link rel=canonical href=https://winddoing.github.io/post/5c89cc1d.html><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://winddoing.github.io/post/5c89cc1d.html","path":"post/5c89cc1d.html","title":"ARMv8异常处理"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>ARMv8异常处理 | Winddoing's Notes</title><script src=/js/third-party/analytics/baidu-analytics.js></script><script async src=https://hm.baidu.com/hm.js?b96a560ce0a6bfbeaaddc59dc5888b75></script><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href="/" class=brand rel=start><i class=logo-line></i><p class=site-title>Winddoing's Notes</p><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Follow Excellent, Success will Chase you</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AF%84%E5%AD%98%E5%99%A8><span class=nav-number>1.</span> <span class=nav-text>异常处理寄存器</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5%E5%BC%82%E5%B8%B8><span class=nav-number>2.</span> <span class=nav-text>同步和异步异常</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#AArch64%E5%BC%82%E5%B8%B8%E8%A1%A8><span class=nav-number>3.</span> <span class=nav-text>AArch64异常表</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86><span class=nav-number>4.</span> <span class=nav-text>中断处理</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E4%B8%AD%E6%96%AD%E6%8E%A7%E5%88%B6%E5%99%A8><span class=nav-number>5.</span> <span class=nav-text>中断控制器</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%B8%AD%E6%96%AD%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%9A><span class=nav-number>5.1.</span> <span class=nav-text>中断可以有多种不同的类型：</span></a></li><li class="nav-item nav-level-3"><a class=nav-link href=#%E4%B8%AD%E6%96%AD%E7%8A%B6%E6%80%81><span class=nav-number>5.2.</span> <span class=nav-text>中断状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class=nav-link href=#GIC%E8%AE%BE%E5%A4%87%E6%A0%91><span class=nav-number>6.</span> <span class=nav-text>GIC设备树</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%8F%82%E8%80%83><span class=nav-number>7.</span> <span class=nav-text>参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=winddoing src=/images/Winddoing.jpg><p class=site-author-name itemprop=name>winddoing</p><div class=site-description itemprop=description>失败缘于忽视细处，成功始于重视小事</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>358</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>112</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>284</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9naXRodWIuY29tL1dpbmRkb2luZw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Winddoing"><i class="fab fa-github fa-fw"></i>GitHub</span></span> <span class=links-of-author-item><span class=exturl data-url=aHR0cHM6Ly9naXRlZS5jb20vd2luZGRvaW5n title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;winddoing"><i class="fab fa-codiepie fa-fw"></i>Gitee</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy85NTY3MzYxL3dpbmRkb2luZw==" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;9567361&#x2F;winddoing"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9hcHAudHJhdmlzLWNpLmNvbS9naXRodWIvV2luZGRvaW5nL3dpbmRkb2luZy5naXRodWIuaW8=" title="Travis CI → https:&#x2F;&#x2F;app.travis-ci.com&#x2F;github&#x2F;Winddoing&#x2F;winddoing.github.io"><i class="fas fa-terminal fa-fw"></i>Travis CI</span></span></div><div class="cc-license site-overview-item animated" itemprop=license><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg alt="Creative Commons"></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="link fa-fw"></i> Links</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cHM6Ly93aW5kZG9pbmcuZ2l0Ym9vay5pby9lbWJlZGRlZF9saW51eF9ub3Rlcy8=" title=https:&#x2F;&#x2F;winddoing.gitbook.io&#x2F;embedded_linux_notes&#x2F;>嵌入式相关</span></li><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2RyZWFtcQ==" title=http:&#x2F;&#x2F;blog.csdn.net&#x2F;sdreamq>CSDN</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cDovL3d3dy53b3dvdGVjaC5uZXQv title=http:&#x2F;&#x2F;www.wowotech.net&#x2F;>蜗窝科技</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpb25neGlhbnpl title=https:&#x2F;&#x2F;blog.csdn.net&#x2F;xiongxianze>xiongxianze</span></li></ul></div><div id=days></div><script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("02/26/2014 15:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=https://winddoing.github.io/post/5c89cc1d.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/Winddoing.jpg><meta itemprop=name content=winddoing></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Winddoing's Notes"><meta itemprop=description content=失败缘于忽视细处，成功始于重视小事></span> <span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="ARMv8异常处理 | Winddoing's Notes"><meta itemprop=description></span><header class=post-header><h1 class=post-title itemprop="name headline">ARMv8异常处理</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2021-11-22 10:04:00" itemprop="dateCreated datePublished" datetime=2021-11-22T10:04:00+08:00>2021-11-22</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/ARM/" itemprop=url rel=index><span itemprop=name>ARM</span></a></span></span> <span id=/post/5c89cc1d.html class="post-meta-item leancloud_visitors" data-flag-title=ARMv8异常处理 title=阅读次数><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span class=leancloud-visitors-count></span></span> <span class=post-meta-item title=阅读次数 id=busuanzi_container_page_pv><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span></span> <span class=post-meta-break></span> <span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>5.3k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>5 分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><p><img data-src=/images/2021/11/arm64_spec_regs.png alt=arm64_spec_regs></p><p>在ARM64中<code>SP</code>（栈指针），由于存在<code>EL0～EL3</code>四种异常级别，因此存在四个<code>SP</code>；但是<code>PC</code>指针只有一个（单核）</p><span id=more></span><ul><li><code>XZR/WZR</code>(Zero register):零寄存器用作源寄存器时读为零，用作目标寄存器时丢弃结果。你可以在大多数（但不是所有）指令中使用零寄存器。</li><li><code>PC</code>（Program Counter）：程序计数器</li><li><code>SP</code>（Stack pointer）： 堆栈指针（SP）是一个指向堆栈顶部的寄存器。 选择使用的堆栈指针在某种程度上与“异常”级别是分开的。 默认情况下，发生异常时会为目标异常级别选择堆栈指针（SP_ELn）</li><li><code>SPSR</code>（Program Status Register）： 发生异常时，处理器状态存储在相关的保存程序状态寄存器 (SPSR) 中，类似于ARMv7中的CPSR。 SPSR在发生异常之前保存PSTATE的值，用于在执行异常返回时恢复PSTATE的值</li><li><code>ELR</code>(Exception Link Register): 异常链接寄存器,保存导致异常的指令的地址</li></ul><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line>EL0为普通用户程序</span><br><span class=line>EL1是操作系统内核相关</span><br><span class=line>EL2是Hypervisor, 可以理解为上面跑多个虚拟OS</span><br><span class=line>EL3是Secure Monitor(ARM Trusted Firmware)</span><br></pre></td></tr></table></figure><p><img data-src=/images/2021/11/arm64_exception_handling.png alt=arm64_exception_handling></p><p>异常类型：</p><ul><li>中断（Interrupts）</li><li>中止（Aborts）</li><li>重置（Reset）</li><li>异常指令（Exception generating instructions）</li></ul><h2 id=异常处理寄存器><a href=#异常处理寄存器 class=headerlink title=异常处理寄存器></a>异常处理寄存器</h2><p>如果发生异常，PSTATE 信息将保存在<code>Saved Program Status Register</code>(SPSR_ELn) 中，该寄存器以<code>SPSR_EL3</code>、<code>SPSR_EL2</code>和<code>SPSR_EL1</code>的形式存在。</p><p><img data-src=/images/2021/11/arm64%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%AF%84%E5%AD%98%E5%99%A8.png alt=arm64异常处理寄存器></p><blockquote><p><code>SPRSR.M</code>字段（第4位）用于记录执行状态（<code>0</code>表示AArch64，<code>1</code>表示AArch32）。</p></blockquote><table><thead><tr><th align=center>PSTATE fields</th><th align=center>描述</th></tr></thead><tbody><tr><td align=center>NZCV</td><td align=center>条件标志</td></tr><tr><td align=center>Q</td><td align=center>累积饱和位</td></tr><tr><td align=center>DAIF</td><td align=center>异常掩码位</td></tr><tr><td align=center>SPSel</td><td align=center>SP选择（EL0或ELn），不适用于EL0</td></tr><tr><td align=center>E</td><td align=center>数据字节序（仅限 AArch32）</td></tr><tr><td align=center>IL</td><td align=center>非法标志</td></tr><tr><td align=center>SS</td><td align=center>软件步进位(单步调试)</td></tr></tbody></table><p>异常掩码位(DAIF)允许屏蔽异常事件，设置该位时不发生异常。</p><ul><li><code>D</code>：Debug exceptions mask.</li><li><code>A</code>：SError interrupt Process state mask, for example, asynchronous External Abort.</li><li><code>I</code>：IRQ interrupt Process state mask</li><li><code>F</code>：FIQ interrupt Process state mask.</li></ul><p>当导致异常的事件发生时，处理器硬件会自动执行某些操作。 更新<code>SPSR_EL</code>（其中n是发生异常的异常级别），以存储在异常结束时正确返回所需的<code>PSTATE</code>信息。 <code>PSTATE</code>被更新以反映新的处理器状态（这可能意味着异常级别被提升，或者它可能保持不变）。 异常结束时使用的返回地址存储在<code>ELR_ELn</code>中。</p><p><img data-src=/images/2021/11/arm64%E5%BC%82%E5%B8%B8%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png alt=arm64异常事件处理流程></p><p>请记住，寄存器名称上的<code>_ELn</code>后缀表示这些寄存器的多个副本存在于不同的异常级别。 例如，<code>SPSR_EL1</code>与<code>SPSR_EL2</code>是不同的物理寄存器。 此外，在同步或SError异常的情况下，ESR_ELn也会更新为指示异常原因的值。</p><p>必须通过软件告知处理器何时从异常中返回。 这是通过执行<code>ERET</code>指令来完成的。 这会从<code>SPSR_ELn</code>恢复异常前的<code>PSTATE</code>，并通过从<code>ELR_ELn</code>恢复<code>PC</code>将程序执行返回到原始位置。</p><p>我们已经看到SPSR如何记录异常返回所需的状态信息。 我们现在将查看用于存储程序地址信息的链接寄存器。 该架构为函数调用和异常返回提供了单独的链接寄存器。</p><p>在A64指令集，寄存器<code>X30</code>用于与<code>RET</code>指令结合）从子程序返回。 每当我们执行带有链接指令（BL或BLR）的分支时，它的值都会使用要返回的指令的地址进行更新。</p><p><code>ELR_ELn</code>寄存器用于存储异常的返回地址。该寄存器中的值（实际上是几个寄存器，正如我们所见）在进入异常时自动写入，并作为执行用于从异常返回的<code>ERET</code>指令的效果之一写入<code>PC</code>。</p><p><strong>注</strong>：从异常返回时，如果<code>SPSR</code>中的值与系统寄存器中的设置冲突，您将看到错误。</p><h2 id=同步和异步异常><a href=#同步和异步异常 class=headerlink title=同步和异步异常></a>同步和异步异常</h2><p>在AArch64中，异常可能是同步的，也可能是异步的。 如果异常是作为指令流的执行或尝试执行的结果而生成的，并且返回地址提供了使用它的指令的详细信息，则该异常被描述为同步异常。 执行指令不会生成异步异常，而返回地址可能并不总是提供导致异常的原因的详细信息。</p><p><code>异步异常</code>的来源是IRQ（正常优先级中断）、FIQ（快速中断）或SError（系统错误）。 系统错误有多种可能的原因，最常见的是异步数据中止（例如，由脏数据从缓存行写回外部存储器触发的中止）。</p><p><code>同步异常</code>有多种来源：</p><ul><li>来自MMU的指令中止。 例如，通过从标记为从不执行的内存位置读取指令。</li><li>来自MMU的数据中止。 例如，权限失败或对齐检查。</li><li>SP和PC对齐检查。</li><li>同步外部中止。 例如，读取翻译表时中止。</li><li>未分配的指令。</li><li>调试异常。</li></ul><h2 id=AArch64异常表><a href=#AArch64异常表 class=headerlink title=AArch64异常表></a>AArch64异常表</h2><p>当异常发生时，处理器必须执行与异常对应的处理程序代码。 存储处理程序的内存位置称为异常向量。 在ARM架构中，异常向量存储在一个表中，称为<code>异常向量表</code>。 每个异常级别都有自己的向量表，即EL3、EL2和EL1各有一个向量表。 该表包含要执行的指令，而不是一组地址。 个别异常的向量位于距表开头的固定偏移量处。每个表基址的虚拟地址由向量基址寄存器（Vector Based Address Registers）<code>VBAR_EL3</code>、<code>VBAR_EL2</code>和<code>VBAR_EL1</code>设置。</p><h2 id=中断处理><a href=#中断处理 class=headerlink title=中断处理></a>中断处理</h2><p>ARM通常使用中断来表示中断信号。 在ARM A-profile和R-profile处理器上，这意味着外部IRQ或FIQ中断信号。 该架构没有指定如何使用这些信号。 FIQ通常保留用于安全中断源。 在早期的体系结构版本中，FIQ和IRQ用于表示高标准中断优先级，但在ARMv8-A中并非如此。</p><p>当处理器对AArch64执行状态发生异常时，所有<code>PSTATE</code>中断掩码都会自动设置，这意味着禁用更多异常。 如果软件要支持嵌套异常，例如，允许较高优先级的中断中断较低优先级源的处理，则软件需要明确地重新启用中断。</p><h2 id=中断控制器><a href=#中断控制器 class=headerlink title=中断控制器></a>中断控制器</h2><p>ARM提供了一个标准的中断控制器，可用于ARMv8-A系统，该中断控制器的编程接口在GIC架构中定义。GIC架构规范有多个版本，本文档侧重于版本2(GICv2)。 ARMv8-A处理器通常连接到GIC，例如GIC-400或GIC-500。通用中断控制器 (GIC) 支持在多核系统中的内核之间路由软件生成的、私有的和共享的外设中断。</p><p>GIC架构提供的寄存器可用于管理中断源和行为以及（在多核系统中）用于将中断路由到各个内核。它使软件能够屏蔽、启用和禁用来自各个源的中断，对（在硬件中）各个源进行优先级排序并生成软件中断。 GIC接受在系统级别断言的中断，并可以将它们发送给它所连接的每个内核，这可能会导致发生IRQ或FIQ异常。</p><p>从软件的角度来看，GIC 有两个主要功能块：</p><ul><li><p><code>Distributor</code>（分发器）</p><ul><li>系统中所有中断源都连接到它。 Distributor具有寄存器来控制各个中断的属性，例如优先级、状态、安全性、路由信息和启用状态。 分配器通过附加的CPU接口确定将哪个中断转发到内核。</li></ul></li><li><p><code>CPU Interface</code>（中央处理器接口）</p><ul><li>内核通过它接收中断。 CPU接口托管寄存器以屏蔽、识别和控制转发到该内核的中断的状态。 系统中的每个内核都有一个单独的CPU接口。</li></ul></li></ul><p>中断在软件中由一个数字标识，称为<code>中断ID</code>。 一个中断ID唯一对应一个中断源，软件可以使用中断ID来识别中断源并调用相应的处理程序来服务中断，提供给软件的确切中断ID由系统设计决定。</p><h3 id=中断可以有多种不同的类型：><a href=#中断可以有多种不同的类型： class=headerlink title=中断可以有多种不同的类型：></a>中断可以有多种不同的类型：</h3><ul><li><p>Software Generated Interrupt (SGI) —— 软件产生中断</p><ul><li>这是由软件通过写入专用分配器寄存器（软件生成中断寄存器 (GICD_SGIR)）显式生成的，它最常用于内核间通信。SGI可以是全部目标，也可以是系统中选定的一组核心。<code>中断ID0-15</code>是为此保留的，用于给定中断的中断ID由生成它的软件设置。</li></ul></li><li><p>Private Peripheral Interrupt (PPI) —— 私有外设中断</p><ul><li>这是一个<code>全局外设中断</code>，分发器可以将其路由到指定的一个或多个内核。 <code>中断ID16-31</code>是为此保留的，它们标识<code>内核私有的中断源</code>，并且独立于另一个内核上的相同源，例如每内核定时器。</li></ul></li><li><p>Shared Peripheral Interrupt (SPI) —— 共享外设中断</p><ul><li>这是由GIC可以路由到多个内核的<code>外设</code>生成的。 <code>中断ID32-1020</code>用于此目的， SPI用于从整个系统中可访问的各种<code>外设发出中断信号</code>。</li></ul></li><li><p>Locality-specific Peripheral Interrupt (LPI) —— 特定于本地的外设中断</p><ul><li>这些是路由到特定内核的基于消息的中断。 GICv2或GICv1不支持LPI。</li></ul></li></ul><h3 id=中断状态><a href=#中断状态 class=headerlink title=中断状态></a>中断状态</h3><p>中断可以是边沿触发的（当 GIC 检测到相关输入的上升沿时被认为是有效的，并保持有效直到被清除）或电平敏感（仅当 GIC 的相关输入为高时才被认为是有效的 ）。</p><p>中断可以处于多种不同的状态：</p><ul><li><code>Inactive</code> —— 意味着当前没有中断</li><li><code>Pending</code> —— 意味着中断源已被中断，但正在等待内核处理。待处理的中断是被转发到CPU接口，然后再转发到内核的候选者</li><li><code>Active</code> —— 意味着已被内核确认并且当前正在服务的中断</li><li><code>Active and pending</code> —— 这描述了内核正在为中断提供服务并且GIC也有来自同一源的挂起中断的情况</li></ul><p>中断状态变化的经典顺序：</p><ul><li>Inactive -&gt; Pending： 当外设发出中断时</li><li>Pending -&gt; Active： 当处理程序确认中断时</li><li>Active -&gt; Inactive： 当句柄处理完中断时</li></ul><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre></td><td class=code><pre><span class=line># cat /proc/interrupts</span><br><span class=line>           CPU0       CPU1</span><br><span class=line></span><br><span class=line>  7:        272          0     GIC-0  66 Level     ttyS0</span><br><span class=line>  9:         71          0     GIC-0  45 Level     mmc0</span><br><span class=line> 10:       1130          0     GIC-0  46 Level     mmc1</span><br><span class=line></span><br><span class=line>IPI0:      3834      12053       Rescheduling interrupts</span><br><span class=line>IPI1:         4          4       Function call interrupts</span><br><span class=line>IPI2:         0          0       CPU stop interrupts</span><br><span class=line>IPI3:         0          0       CPU stop (for crash dump) interrupts</span><br><span class=line>IPI4:         0          0       Timer broadcast interrupts</span><br><span class=line>IPI5:         0          0       IRQ work interrupts</span><br><span class=line>IPI6:         0          0       CPU wake-up interrupts</span><br><span class=line>Err:          0</span><br><span class=line>#</span><br></pre></td></tr></table></figure><p>GIC-V2中SPI中断不支持多核迁移，GIC-V3中SPI中断支持多核迁移</p><h2 id=GIC设备树><a href=#GIC设备树 class=headerlink title=GIC设备树></a>GIC设备树</h2><blockquote><p><span class=exturl data-url="aHR0cHM6Ly9lbGl4aXIuYm9vdGxpbi5jb20vbGludXgvdjUuNC4xMTAvc291cmNlL0RvY3VtZW50YXRpb24vZGV2aWNldHJlZS9iaW5kaW5ncy9pbnRlcnJ1cHQtY29udHJvbGxlci9hcm0sZ2ljLnlhbWw=">Documentation&#x2F;devicetree&#x2F;bindings&#x2F;interrupt-controller&#x2F;arm,gic.yaml<i class="fa fa-external-link-alt"></i></span></p></blockquote><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line>&quot;#interrupt-cells&quot;:</span><br><span class=line>  const: 3</span><br><span class=line>  description: |</span><br><span class=line>    The 1st cell is the interrupt type; 0 for SPI interrupts, 1 for PPI</span><br><span class=line>    interrupts.</span><br><span class=line></span><br><span class=line>    The 2nd cell contains the interrupt number for the interrupt type.</span><br><span class=line>    SPI interrupts are in the range [0-987].  PPI interrupts are in the</span><br><span class=line>    range [0-15].</span><br><span class=line></span><br><span class=line>    The 3rd cell is the flags, encoded as follows:</span><br><span class=line>      bits[3:0] trigger type and level flags.</span><br><span class=line>        1 = low-to-high edge triggered</span><br><span class=line>        2 = high-to-low edge triggered (invalid for SPIs)</span><br><span class=line>        4 = active high level-sensitive</span><br><span class=line>        8 = active low level-sensitive (invalid for SPIs).</span><br><span class=line>      bits[15:8] PPI interrupt cpu mask.  Each bit corresponds to each of</span><br><span class=line>      the 8 possible cpus attached to the GIC.  A bit set to &#x27;1&#x27; indicated</span><br><span class=line>      the interrupt is wired to that CPU.  Only valid for PPI interrupts.</span><br><span class=line>      Also note that the configurability of PPI interrupts is IMPLEMENTATION</span><br><span class=line>      DEFINED and as such not guaranteed to be present (most SoC available</span><br><span class=line>      in 2014 seem to ignore the setting of this flag and use the hardware</span><br><span class=line>      default value).</span><br></pre></td></tr></table></figure><p>第二个单元格包含中断号,在配置SPI中断号时，由于硬件中断号的前32个中断号被PPI中断使用，因此在设备树中配置时应该是硬件中断号减去32。</p><h2 id=参考><a href=#参考 class=headerlink title=参考></a>参考</h2><ul><li>DEN0024A_v8_architecture_PG.pdf</li></ul></div><footer class=post-footer><div class=post-copyright><ul><li class=post-copyright-author><strong>本文作者：</strong>winddoing</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://winddoing.github.io/post/5c89cc1d.html title=ARMv8异常处理>https://winddoing.github.io/post/5c89cc1d.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <span class=exturl data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class=post-tags><a href="/tags/arm64/" rel=tag><i class="fa fa-tag"></i> arm64</a> <a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" rel=tag><i class="fa fa-tag"></i> 异常处理</a></div><div class=post-nav><div class=post-nav-item><a href=/post/3099dbdc.html rel=prev title=linux内核spinlock死锁——两核互锁><i class="fa fa-chevron-left"></i> linux内核spinlock死锁——两核互锁</a></div><div class=post-nav-item><a href=/post/5a220639.html rel=next title=VCC（电源）和GND（地）之间电容的作用>VCC（电源）和GND（地）之间电容的作用 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2014 – <span itemprop=copyrightYear>2023</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>winddoing</span></div><div class=wordcount><span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-chart-line"></i></span> <span title=站点总字数>1.1m</span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span title=站点阅读时长>16:21</span></span></div><div class=busuanzi-count><span class=post-meta-item id=busuanzi_container_site_uv><span class=post-meta-item-icon><i class="fa fa-users"></i></span> <span class=site-uv title=总访客量><span id=busuanzi_value_site_uv></span></span></span> <span class=post-meta-item id=busuanzi_container_site_pv><span class=post-meta-item-icon><i class="fa fa-eye"></i></span> <span class=site-pv title=总访问量><span id=busuanzi_value_site_pv></span></span></span></div><div class=powered-by>由 <span class=exturl data-url=aHR0cHM6Ly9oZXhvLmlv>Hexo</span> & <span class=exturl data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9taXN0Lw==">NexT.Mist</span> 强力驱动</div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script class=next-config data-name=pdf type=application/json>{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src=/js/third-party/tags/pdf.js></script><script class=next-config data-name=mermaid type=application/json>{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js","integrity":"sha256-8L3O8tirFUa8Va4NSTAyIbHJeLd6OnlcxgupV9F77e0="}}</script><script src=/js/third-party/tags/mermaid.js></script><script src=/js/third-party/fancybox.js></script><script data-pjax async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script class=next-config data-name=leancloud_visitors type=application/json>{"enable":true,"app_id":"Q8qpjA3fOO7FEUBqcmcQFptF-gzGzoHsz","app_key":"tgUTq5bX3fVmn916EMRe65eJ","server_url":null,"security":false}</script><script src=/js/third-party/statistics/lean-analytics.js></script><script class=next-config data-name=enableMath type=application/json>false</script><script class=next-config data-name=mathjax type=application/json>{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.js","integrity":"sha256-hlC2uSQYTmPsrzGZTEQEg9PZ1a/+SV6VBCTclohf2og="}}</script><script src=/js/third-party/math/mathjax.js></script><script class=next-config data-name=utterances type=application/json>{"enable":true,"repo":"Winddoing/winddoing.github.io","issue_term":"title","theme":"github-light"}</script><script src=/js/third-party/comments/utterances.js></script></body></html>