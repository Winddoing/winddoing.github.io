<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=#222 media="(prefers-color-scheme: light)"><meta name=theme-color content=#222 media="(prefers-color-scheme: dark)"><meta name=generator content="Hexo 6.2.0"><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preconnect href=https://cdnjs.cloudflare.com crossorigin><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/favicon.ico><link rel=mask-icon href=/images/logo.svg color=#222><meta name=baidu-site-verification content=WIIeufYjj6><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Microsoft+YaHei:300,300italic,400,400italic,700,700italic%7Ccmmi10:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><script class=next-config data-name=main type=application/json>{"hostname":"winddoing.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.12.1","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content=原文：https:&#x2F;&#x2F;blogs.igalia.com&#x2F;itoral&#x2F;2015&#x2F;03&#x2F;03&#x2F;an-introduction-to-mesas-glsl-compiler-i&#x2F;><meta property=og:type content=article><meta property=og:title content="[转]An introduction to Mesa’s GLSL compiler (I)[翻译]"><meta property=og:url content=https://winddoing.github.io/post/af8dbdc1.html><meta property=og:site_name content="Winddoing&#39;s Notes"><meta property=og:description content=原文：https:&#x2F;&#x2F;blogs.igalia.com&#x2F;itoral&#x2F;2015&#x2F;03&#x2F;03&#x2F;an-introduction-to-mesas-glsl-compiler-i&#x2F;><meta property=og:locale content=zh_CN><meta property=article:published_time content=2021-07-20T11:26:00.000Z><meta property=article:modified_time content=2023-12-16T04:58:17.925Z><meta property=article:author content=winddoing><meta property=article:tag content=mesa><meta property=article:tag content=glsl><meta property=article:tag content=opengl><meta name=twitter:card content=summary><link rel=canonical href=https://winddoing.github.io/post/af8dbdc1.html><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://winddoing.github.io/post/af8dbdc1.html","path":"post/af8dbdc1.html","title":"[转]An introduction to Mesa’s GLSL compiler (I)[翻译]"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>[转]An introduction to Mesa’s GLSL compiler (I)[翻译] | Winddoing's Notes</title><script src=/js/third-party/analytics/baidu-analytics.js></script><script async src=https://hm.baidu.com/hm.js?b96a560ce0a6bfbeaaddc59dc5888b75></script><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href="/" class=brand rel=start><i class=logo-line></i><p class=site-title>Winddoing's Notes</p><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Follow Excellent, Success will Chase you</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel=section><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel=section><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel=section><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%9B%9E%E9%A1%BE><span class=nav-number>1.</span> <span class=nav-text>回顾</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#GLSL%E8%A7%A3%E6%9E%90%E5%99%A8><span class=nav-number>2.</span> <span class=nav-text>GLSL解析器</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#Mesa-IR><span class=nav-number>3.</span> <span class=nav-text>Mesa IR</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E7%A9%BF%E8%B6%8A-Mesa-IR><span class=nav-number>4.</span> <span class=nav-text>穿越 Mesa IR</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F%E5%92%8C%E5%87%BD%E6%95%B0><span class=nav-number>5.</span> <span class=nav-text>内置变量和函数</span></a></li><li class="nav-item nav-level-2"><a class=nav-link href=#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E4%BA%8B><span class=nav-number>6.</span> <span class=nav-text>接下来的事</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=winddoing src=/images/Winddoing.jpg><p class=site-author-name itemprop=name>winddoing</p><div class=site-description itemprop=description>失败缘于忽视细处，成功始于重视小事</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href="/archives/"><span class=site-state-item-count>358</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class=site-state-item-count>112</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class=site-state-item-count>284</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9naXRodWIuY29tL1dpbmRkb2luZw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Winddoing"><i class="fab fa-github fa-fw"></i>GitHub</span></span> <span class=links-of-author-item><span class=exturl data-url=aHR0cHM6Ly9naXRlZS5jb20vd2luZGRvaW5n title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;winddoing"><i class="fab fa-codiepie fa-fw"></i>Gitee</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS91c2Vycy85NTY3MzYxL3dpbmRkb2luZw==" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;9567361&#x2F;winddoing"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</span></span> <span class=links-of-author-item><span class=exturl data-url="aHR0cHM6Ly9hcHAudHJhdmlzLWNpLmNvbS9naXRodWIvV2luZGRvaW5nL3dpbmRkb2luZy5naXRodWIuaW8=" title="Travis CI → https:&#x2F;&#x2F;app.travis-ci.com&#x2F;github&#x2F;Winddoing&#x2F;winddoing.github.io"><i class="fas fa-terminal fa-fw"></i>Travis CI</span></span></div><div class="cc-license site-overview-item animated" itemprop=license><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src=https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg alt="Creative Commons"></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="link fa-fw"></i> Links</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cHM6Ly93aW5kZG9pbmcuZ2l0Ym9vay5pby9lbWJlZGRlZF9saW51eF9ub3Rlcy8=" title=https:&#x2F;&#x2F;winddoing.gitbook.io&#x2F;embedded_linux_notes&#x2F;>嵌入式相关</span></li><li class=links-of-blogroll-item><span class=exturl data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2RyZWFtcQ==" title=http:&#x2F;&#x2F;blog.csdn.net&#x2F;sdreamq>CSDN</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cDovL3d3dy53b3dvdGVjaC5uZXQv title=http:&#x2F;&#x2F;www.wowotech.net&#x2F;>蜗窝科技</span></li><li class=links-of-blogroll-item><span class=exturl data-url=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpb25neGlhbnpl title=https:&#x2F;&#x2F;blog.csdn.net&#x2F;xiongxianze>xiongxianze</span></li></ul></div><div id=days></div><script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("02/26/2014 15:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class=reading-progress-bar></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=https://winddoing.github.io/post/af8dbdc1.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/Winddoing.jpg><meta itemprop=name content=winddoing></span> <span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Winddoing's Notes"><meta itemprop=description content=失败缘于忽视细处，成功始于重视小事></span> <span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="[转]An introduction to Mesa’s GLSL compiler (I)[翻译] | Winddoing's Notes"><meta itemprop=description></span><header class=post-header><h1 class=post-title itemprop="name headline">[转]An introduction to Mesa’s GLSL compiler (I)[翻译]</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span> <span class=post-meta-item-text>发表于</span><time title="创建时间：2021-07-20 19:26:00" itemprop="dateCreated datePublished" datetime=2021-07-20T19:26:00+08:00>2021-07-20</time></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i></span> <span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href="/categories/%E5%A4%9A%E5%AA%92%E4%BD%93/" itemprop=url rel=index><span itemprop=name>多媒体</span></a></span></span> <span id=/post/af8dbdc1.html class="post-meta-item leancloud_visitors" data-flag-title="[转]An introduction to Mesa’s GLSL compiler (I)[翻译]" title=阅读次数><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span class=leancloud-visitors-count></span></span> <span class=post-meta-item title=阅读次数 id=busuanzi_container_page_pv><span class=post-meta-item-icon><i class="far fa-eye"></i></span> <span class=post-meta-item-text>阅读次数：</span> <span id=busuanzi_value_page_pv></span></span> <span class=post-meta-break></span> <span class=post-meta-item title=本文字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span> <span class=post-meta-item-text>本文字数：</span> <span>7.1k</span></span> <span class=post-meta-item title=阅读时长><span class=post-meta-item-icon><i class="far fa-clock"></i></span> <span class=post-meta-item-text>阅读时长 &asymp;</span> <span>6 分钟</span></span></div></div></header><div class=post-body itemprop=articleBody><p>原文：<span class=exturl data-url=aHR0cHM6Ly9ibG9ncy5pZ2FsaWEuY29tL2l0b3JhbC8yMDE1LzAzLzAzL2FuLWludHJvZHVjdGlvbi10by1tZXNhcy1nbHNsLWNvbXBpbGVyLWkv>https://blogs.igalia.com/itoral/2015/03/03/an-introduction-to-mesas-glsl-compiler-i/<i class="fa fa-external-link-alt"></i></span></p><span id=more></span><h2 id=回顾><a href=#回顾 class=headerlink title=回顾></a>回顾</h2><p>在我的上一篇文章中，我解释了现代 3D 管道是可编程的，以及这如何影响图形驱动程序。在接下来的文章中，我们将通过查看 Mesa GLSL 编译器的不同部分来更深入地研究这个方面。具体来说，这篇文章将涵盖 GLSL 解析器、Mesa IR 以及内置变量和函数。</p><h2 id=GLSL解析器><a href=#GLSL解析器 class=headerlink title=GLSL解析器></a>GLSL解析器</h2><p>解析器的工作是处理通过glShaderSource提供的shader源代码字符串，并将其转换为存储在RAM中的合适的二进制表示，并可以在后期由编译器的其他部分有效处理。</p><p>解析器由一组Lex&#x2F;Yacc规则组成，用于处理传入的shader source。词法分析器 ( glsl_parser.ll ) 负责对源代码进行标记，解析器 ( glsl_parser.yy ) 为词法分析器阶段识别的标记流添加含义。</p><p>类似地，就像在C或c++中一样，GLSL包含了一个预处理程序，在主解析器启动之前，它将遍历着色器源代码。Mesa的GLSL预处理程序的实现存在于src&#x2F;glsl&#x2F;glcpp中，也基于Lex&#x2F;Yacc规则。</p><p>解析器的输出是一个驻留在RAM内存中的抽象语法树 (AST)，它是着色器源代码的二进制表示。生成这棵树的节点在src&#x2F;glsl&#x2F;ast.h中定义。</p><p>对于熟悉所有Lex&#x2F;Yacc内容的人来说，Mesa 中的解析器实现应该足够熟悉了。</p><p>下一步是将AST转换为更适合驱动程序处理的那种操作,这种新的表示，称为IR（中间表示），在 Mesa 中通常被称为Mesa IR、GLSL IR或简称HIR。</p><p>在AST到Mesa IR转化是通过在代码src&#x2F;glsl&#x2F;ast_to_hir.cpp。</p><h2 id=Mesa-IR><a href=#Mesa-IR class=headerlink title="Mesa IR"></a>Mesa IR</h2><p>Mesa IR是在编译器中使用的主要数据结构。编译器所做的大部分工作可以总结为：</p><ul><li>IR 中的优化</li><li>修改 IR 以更好地&#x2F;更容易地与GPU硬件集成</li><li>将多个着色器（多个 IR 实例）链接到一个程序中。</li><li>从 IR 为目标 GPU 生成本机汇编代码</li></ul><p>正如我们所见，Mesa IR 是编译器必须完成的所有工作的核心，因此了解它是如何设置的对于在 Mesa 的这一部分工作是必要的。</p><p>Mesa IR 树中的节点在src&#x2F;glsl&#x2F;ir.h中定义。让我们来看看最重要的：</p><p>在 IR 节点的类层次结构的顶部，我们有exec_node，这是 Mesa 将独立指令链接到列表中以制作程序的方式。这意味着每条指令都有上一个和下一个指针，分别指向它之前和之后的指令。所以，我们有ir_instruction，树中所有节点的基类，继承自exec_node。</p><p>另一个重要节点是ir_rvalue，它是用于表示表达式的基类。通常，任何可以放在赋值右侧的东西都是ir_rvalue。ir_rvalue 的子类包括ir_expression，用于表示各种一元、二元或三元运算（支持的运算符在ir_expression_operation枚举中定义），ir_texture，用于表示纹理查找等纹理操作，ir_swizzle，用于swizzling向量中的值，所有ir_dereference 节点，用于访问存储在变量、数组、结构等中的值和ir_constant, 用于表示所有基本类型（bool、float、integer 等）的常量。</p><p>我们还有ir_variable，它代表着色器代码中的变量。请注意，ir_variable的定义非常大……事实上，在大型游戏&#x2F;应用程序中编译着色器时，这是对编译器内存占用影响最大的节点。另请注意，IR 区分变量和变量取消引用（查看变量值的事实），它们表示为ir_rvalue。</p><p>同样，IR 也为其他语言结构定义了节点，如ir_loop、ir_if、ir_assignment等。</p><p>调试 IR 并不容易，因为在 IR 节点中表示着色器程序可能非常复杂，无法使用调试器进行遍历和检查。为了帮助解决这个问题，Mesa 提供了将 IR 打印为人类可读文本格式的方法。我们可以通过使用环境变量MESA_GLSL&#x3D;dump来启用它。这将指示 Mesa 打印原始着色器源代码及其 IR 表示。例如：</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br></pre></td><td class=code><pre><span class=line></span><br><span class=line>$ MESA_GLSL=dump ./test_program</span><br><span class=line></span><br><span class=line>GLSL source for vertex shader 1:</span><br><span class=line>#version 140</span><br><span class=line>#extension GL_ARB_explicit_attrib_location : enable</span><br><span class=line></span><br><span class=line>layout(location = 0) in vec3 inVertexPosition;</span><br><span class=line>layout(location = 1) in vec3 inVertexColor;</span><br><span class=line></span><br><span class=line>uniform mat4 MVP;</span><br><span class=line>smooth out vec3 out0;</span><br><span class=line></span><br><span class=line>void main()</span><br><span class=line>&#123;</span><br><span class=line>  gl_Position = MVP * vec4(inVertexPosition, 1);</span><br><span class=line>  out0 = inVertexColor;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>GLSL IR for shader 1:</span><br><span class=line>(</span><br><span class=line>(declare (sys ) int gl_InstanceID)</span><br><span class=line>(declare (sys ) int gl_VertexID)</span><br><span class=line>(declare (shader_out ) (array float 0) gl_ClipDistance)</span><br><span class=line>(declare (shader_out ) float gl_PointSize)</span><br><span class=line>(declare (shader_out ) vec4 gl_Position)</span><br><span class=line>(declare (uniform ) (array vec4 56) gl_CurrentAttribFragMESA)</span><br><span class=line>(declare (uniform ) (array vec4 33) gl_CurrentAttribVertMESA)</span><br><span class=line>(declare (uniform ) gl_DepthRangeParameters gl_DepthRange)</span><br><span class=line>(declare (uniform ) int gl_NumSamples)</span><br><span class=line>(declare () int gl_MaxVaryingComponents)</span><br><span class=line>(declare () int gl_MaxClipDistances)</span><br><span class=line>(declare () int gl_MaxFragmentUniformComponents)</span><br><span class=line>(declare () int gl_MaxVaryingFloats)</span><br><span class=line>(declare () int gl_MaxVertexUniformComponents)</span><br><span class=line>(declare () int gl_MaxDrawBuffers)</span><br><span class=line>(declare () int gl_MaxTextureImageUnits)</span><br><span class=line>(declare () int gl_MaxCombinedTextureImageUnits)</span><br><span class=line>(declare () int gl_MaxVertexTextureImageUnits)</span><br><span class=line>(declare () int gl_MaxVertexAttribs)</span><br><span class=line>(declare (shader_in ) vec3 inVertexPosition)</span><br><span class=line>(declare (shader_in ) vec3 inVertexColor)</span><br><span class=line>(declare (uniform ) mat4 MVP)</span><br><span class=line>(declare (shader_out smooth) vec3 out0)</span><br><span class=line>(function main</span><br><span class=line>  (signature void</span><br><span class=line>    (parameters</span><br><span class=line>    )</span><br><span class=line>    (</span><br><span class=line>      (declare (temporary ) vec4 vec_ctor)</span><br><span class=line>      (assign  (w) (var_ref vec_ctor)  (constant float (1.000000)) )</span><br><span class=line>      (assign  (xyz) (var_ref vec_ctor)  (var_ref inVertexPosition) )</span><br><span class=line>      (assign  (xyzw) (var_ref gl_Position)</span><br><span class=line>            (expression vec4 * (var_ref MVP) (var_ref vec_ctor) ) )</span><br><span class=line>      (assign  (xyz) (var_ref out0)  (var_ref inVertexColor) )</span><br><span class=line>    ))</span><br><span class=line>)</span><br><span class=line>)</span><br></pre></td></tr></table></figure><p>但是请注意，我们得到的 IR 表示不是解析器生成的。正如我们稍后将看到的，Mesa 将通过多种方式修改初始 IR，例如通过添加不同类型的优化，因此我们看到的 IR 是所有这些处理通过原始 IR 后的结果。Mesa 将这个经过后处理的 IR 版本称为LIR（低级 IR），并将解析器生成的 IR 的初始版本称为HIR（高级 IR）。如果我们想打印HIR（或 IR 转换为最终LIR 的任何中间版本），我们可以编辑编译器并根据需要添加对 _mesa_print_ir 的调用。</p><h2 id=穿越-Mesa-IR><a href=#穿越-Mesa-IR class=headerlink title="穿越 Mesa IR"></a>穿越 Mesa IR</h2><p>我们之前提到过编译器的一些工作（实际上是很大一部分）与 IR 的优化和修改有关。这意味着编译器需要遍历 IR 树并识别与此类操作相关的子树。为了实现这一点，Mesa 使用了访问者设计模式。</p><p>基本上，这个想法是我们有一个可以遍历 IR 树的访问者对象，我们可以定义当它找到特定节点时我们想要执行的行为。</p><p>例如，在src&#x2F;glsl&#x2F;linker.cpp 中有一个非常简单的例子：find_deref_visitor，它检测变量是否被读取。这涉及遍历 IR，识别ir_dereference_variable节点（访问变量值的节点）并检查该变量的名称是否与我们要查找的名称匹配。这是访问者类定义：</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><span class=line>/**</span><br><span class=line> * Visitor that determines whether or not a variable is ever read.</span><br><span class=line> */</span><br><span class=line>class find_deref_visitor : public ir_hierarchical_visitor &#123;</span><br><span class=line>public:</span><br><span class=line>   find_deref_visitor(const char *name)</span><br><span class=line>      : name(name), found(false)</span><br><span class=line>   &#123;</span><br><span class=line>      /* empty */</span><br><span class=line>   &#125;</span><br><span class=line></span><br><span class=line>   virtual ir_visitor_status visit(ir_dereference_variable *ir)</span><br><span class=line>   &#123;</span><br><span class=line>      if (strcmp(this-&gt;name, ir-&gt;var-&gt;name) == 0) &#123;</span><br><span class=line>         this-&gt;found = true;</span><br><span class=line>         return visit_stop;</span><br><span class=line>      &#125;</span><br><span class=line></span><br><span class=line>      return visit_continue;</span><br><span class=line>   &#125;</span><br><span class=line></span><br><span class=line>   bool variable_found() const</span><br><span class=line>   &#123;</span><br><span class=line>      return this-&gt;found;</span><br><span class=line>   &#125;</span><br><span class=line></span><br><span class=line>private:</span><br><span class=line>   const char *name;       /**&lt; Find writes to a variable with this name. */</span><br><span class=line>   bool found;             /**&lt; Was a write to the variable found? */</span><br><span class=line>&#125;;</span><br></pre></td></tr></table></figure><p>这就是我们如何使用它，例如检查着色器代码是否曾经读取gl_Vertex：</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>find_deref_visitor find(&quot;gl_Vertex&quot;);</span><br><span class=line>find.run(sh-&gt;ir);</span><br><span class=line>if (find.variable_found()) &#123;</span><br><span class=line>  (...)</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>Mesa 中的大多数优化和降低通道都是作为访问者实现的，并遵循类似的想法。我们将在后面的文章中查看这些示例</p><h2 id=内置变量和函数><a href=#内置变量和函数 class=headerlink title=内置变量和函数></a>内置变量和函数</h2><p>GLSL 为 Mesa 自动注入着色器代码的每个着色器阶段定义了一组内置变量（带有“gl_”前缀）。如果您查看我们使用<code>MESA_GLSL=dump</code>获取生成的Mesa IR的示例，您可以看到其中一些变量。</p><p>Mesa 在_mesa_glsl_initialize_variables() 中实现了对内置变量的支持，定义在src&#x2F;glsl&#x2F;builtin_variables.cpp 中。</p><p>请注意，其中一些变量对所有着色器阶段都是通用的，而有些变量特定于特定阶段或仅在特定版本的 GLSL 中可用。</p><p>根据变量的类型，Mesa 或硬件驱动程序可能能够立即提供值（例如，对于保存常量值的变量，如gl_MaxVertexAttribs或gl_MaxDrawBuffers）。否则，驱动程序可能必须在程序运行时通过生成添加到用户程序的本机代码从硬件中获取（或生成）变量的值。例如，使用gl_PrimitiveID的几何着色器将需要为绘制调用中几何着色器单元处理的每个图元更新该变量。为了实现这一点，驱动程序可能必须生成本机代码，从硬件获取当前原始 ID 值并将其存储在寄存器中，该寄存器为执行用户代码之前的gl_PrimitveID变量。</p><p>GLSL 语言还定义了许多必须由实现者提供的可用内置函数，例如texture()、mix() 或 dot() 等，仅举几例。Mesa 的 GLSL 编译器中内置函数的入口点是src&#x2F;glsl&#x2F;builtin_functions.cpp。</p><p>方法builtin_builder::create_builtins()负责注册内置函数，就像内置变量一样，并非所有函数都始终可用：某些函数可能仅在某些着色单元中可用，而其他函数可能仅在某些 GLSL 版本等。为此，每个内置函数都注册了一个谓词，该谓词可用于测试该函数在特定场景中是否完全可用。</p><p>内置函数通过调用add_function()方法注册，该方法注册特定函数的所有版本。例如，用于 float、vec2、vec3、vec4 等的mix()这些版本中的每一个都有自己的可用性谓词。例如，mix()始终可用于浮点参数，但将其与整数一起使用需要GLSL 1.30和EXT_shader_integer_mix扩展。</p><p>除了可用性谓词之外，add_function()还接受一个ir_function_signature，它告诉 Mesa 正在注册的函数的特定签名。请注意，当 Mesa 为函数创建签名时，它还定义了函数体。例如，以下代码片段定义了modf()的签名：</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre></td><td class=code><pre><span class=line>ir_function_signature *</span><br><span class=line>builtin_builder::_modf(builtin_available_predicate avail,</span><br><span class=line>                       const glsl_type *type)</span><br><span class=line>&#123;</span><br><span class=line>   ir_variable *x = in_var(type, &quot;x&quot;);</span><br><span class=line>   ir_variable *i = out_var(type, &quot;i&quot;);</span><br><span class=line>   MAKE_SIG(type, avail, 2, x, i);</span><br><span class=line></span><br><span class=line>   ir_variable *t = body.make_temp(type, &quot;t&quot;);</span><br><span class=line>   body.emit(assign(t, expr(ir_unop_trunc, x)));</span><br><span class=line>   body.emit(assign(i, t));</span><br><span class=line>   body.emit(ret(sub(x, t)));</span><br><span class=line></span><br><span class=line>   return sig;</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><p>GLSL 的modf()将数字拆分为整数和小数部分。它将整数部分分配给输出参数，函数返回值是小数部分。</p><p>我们在上面看到的这个签名定义了类型为“type”的输入参数“x”（我们想要分割的数字）、一个相同类型的输出参数“i”（它将保存“x”的整数部分）和一个返回值输入“类型”。</p><p>函数实现基于一元运算符ir_unop_trunc的存在，它可以取一个数字并提取其整数部分。然后它通过从原始数字中减去小数部分来计算小数部分。</p><p>当使用modf()内置函数时，调用将被扩展以包含此 IR 代码，稍后将通过相应的硬件驱动程序将其转换为 GPU 的本机代码。在这种情况下，这意味着硬件驱动预计将提供所述的实现ir_unop_trunc操作者，例如，其在Intel i965的驱动器的情况下，作为一个单一的硬件指令被实现（见brw_vec4_visitor.cpp或brw_fs_visitor.cpp,在src&#x2F;mesa&#x2F;drivers&#x2F;dri&#x2F;i965）。</p><p>在某些情况下，无法在 IR 级别定义内置函数的实现。在这种情况下，实现只是发出一个临时 IR 节点，驱动程序可以适当地识别和扩展。一个例子是几何着色器中的EmitVertex()。这并不是传统意义上的真正函数调用，而是一种向驱动程序发出信号的方式，即我们已经定义了一个顶点的所有属性，是时候将该顶点“推”到当前图元中了。“推动顶点”的含义无法在 IR 级别定义，因为每个驱动程序&#x2F;硬件都会有所不同。因此，内置函数只需注入一个 IR 节点ir_emit_vertex驾驶员可以在时机成熟时识别并正确实施。在英特尔代码的情况下，推送顶点涉及许多与硬件非常交织的步骤，但它基本上相当于生成实现硬件期望发生的行为的本机代码。如果您很好奇，可以在brw_vec4_gs_visitor.cpp中的 i965 驱动程序代码中找到它的实现，该方法在将ir_emit_vertex IR 节点作为参数的visit()方法中。</p><h2 id=接下来的事><a href=#接下来的事 class=headerlink title=接下来的事></a>接下来的事</h2><p>在这篇文章中，我们讨论了解析器，它是编译器的入口点，并介绍了主要数据结构Mesa IR。在接下来的文章中，我们将深入研究 GLSL 编译器的实现。具体来说，我们将研究降低和优化过程以及链接过程和处理本机代码生成的硬件驱动程序的钩子。</p></div><footer class=post-footer><div class=post-copyright><ul><li class=post-copyright-author><strong>本文作者：</strong>winddoing</li><li class=post-copyright-link><strong>本文链接：</strong> <a href=https://winddoing.github.io/post/af8dbdc1.html title="[转]An introduction to Mesa’s GLSL compiler (I)[翻译]">https://winddoing.github.io/post/af8dbdc1.html</a></li><li class=post-copyright-license><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <span class=exturl data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class=post-tags><a href="/tags/mesa/" rel=tag><i class="fa fa-tag"></i> mesa</a> <a href="/tags/glsl/" rel=tag><i class="fa fa-tag"></i> glsl</a> <a href="/tags/opengl/" rel=tag><i class="fa fa-tag"></i> opengl</a></div><div class=post-nav><div class=post-nav-item><a href=/post/647daf2a.html rel=prev title="WIFEXITED WEXITSTATUS WIFSIGNALED"><i class="fa fa-chevron-left"></i> WIFEXITED WEXITSTATUS WIFSIGNALED</a></div><div class=post-nav-item><a href=/post/1e9ef115.html rel=next title="[转]An introduction to Mesa’s GLSL compiler (II)[翻译]">[转]An introduction to Mesa’s GLSL compiler (II)[翻译] <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2014 – <span itemprop=copyrightYear>2023</span> <span class=with-love><i class="fa fa-heart"></i></span> <span class=author itemprop=copyrightHolder>winddoing</span></div><div class=wordcount><span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-chart-line"></i></span> <span title=站点总字数>1.1m</span></span> <span class=post-meta-item><span class=post-meta-item-icon><i class="fa fa-coffee"></i></span> <span title=站点阅读时长>16:21</span></span></div><div class=busuanzi-count><span class=post-meta-item id=busuanzi_container_site_uv><span class=post-meta-item-icon><i class="fa fa-users"></i></span> <span class=site-uv title=总访客量><span id=busuanzi_value_site_uv></span></span></span> <span class=post-meta-item id=busuanzi_container_site_pv><span class=post-meta-item-icon><i class="fa fa-eye"></i></span> <span class=site-pv title=总访问量><span id=busuanzi_value_site_pv></span></span></span></div><div class=powered-by>由 <span class=exturl data-url=aHR0cHM6Ly9oZXhvLmlv>Hexo</span> & <span class=exturl data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9taXN0Lw==">NexT.Mist</span> 强力驱动</div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/schemes/muse.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script class=next-config data-name=pdf type=application/json>{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script><script src=/js/third-party/tags/pdf.js></script><script class=next-config data-name=mermaid type=application/json>{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.1/mermaid.min.js","integrity":"sha256-8L3O8tirFUa8Va4NSTAyIbHJeLd6OnlcxgupV9F77e0="}}</script><script src=/js/third-party/tags/mermaid.js></script><script src=/js/third-party/fancybox.js></script><script data-pjax async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script class=next-config data-name=leancloud_visitors type=application/json>{"enable":true,"app_id":"Q8qpjA3fOO7FEUBqcmcQFptF-gzGzoHsz","app_key":"tgUTq5bX3fVmn916EMRe65eJ","server_url":null,"security":false}</script><script src=/js/third-party/statistics/lean-analytics.js></script><script class=next-config data-name=enableMath type=application/json>false</script><script class=next-config data-name=mathjax type=application/json>{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.js","integrity":"sha256-hlC2uSQYTmPsrzGZTEQEg9PZ1a/+SV6VBCTclohf2og="}}</script><script src=/js/third-party/math/mathjax.js></script><script class=next-config data-name=utterances type=application/json>{"enable":true,"repo":"Winddoing/winddoing.github.io","issue_term":"title","theme":"github-light"}</script><script src=/js/third-party/comments/utterances.js></script></body></html>